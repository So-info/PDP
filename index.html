<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Suivi D√©fi -30 kg ‚Äî Ultra simple</title>
  <meta name="theme-color" content="#F97316" />

  <!-- Carte (Leaflet + OpenStreetMap) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --orange:#F97316;
      --orange2:#FB923C;
      --bg:#F6F7F9;
      --card:#FFFFFF;
      --text:#111827;
      --muted:#6B7280;
      --line:#E5E7EB;
      --shadow: 0 8px 20px rgba(17,24,39,.08);
      --r:16px;
      --good:#16A34A;
      --bad:#DC2626;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text)}
    header{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(90deg,var(--orange),var(--orange2));
      color:#fff; padding:16px 14px 14px;
      box-shadow: 0 10px 22px rgba(249,115,22,.25);
    }
    header .top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    header h1{margin:0;font-size:18px;letter-spacing:.2px}

    .wrap{max-width:900px;margin:0 auto;padding:12px 14px 40px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .stack{display:grid;gap:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 160px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, button, select, textarea{
      width:100%;border-radius:12px;border:1px solid var(--line);background:#fff;
      padding:11px 12px;font-size:16px;outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color:rgba(249,115,22,.6);box-shadow:0 0 0 3px rgba(249,115,22,.14)}
    textarea{resize:vertical}
    button{
      background:var(--orange);color:#fff;font-weight:900;cursor:pointer;border:none;
      -webkit-tap-highlight-color:transparent;
    }
    button.secondary{background:#fff;color:var(--text);border:1px solid var(--line);font-weight:800}
    button:disabled{opacity:.55;cursor:not-allowed}

    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(min-width:720px){.kpis{grid-template-columns:repeat(4,1fr)}}
    .kpi{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi .v{margin-top:6px;font-size:18px;font-weight:950}
    .pos{color:var(--good)} .neg{color:var(--bad)}
    canvas{width:100%;height:220px;border-radius:14px;border:1px solid var(--line);background:#fff}

    .tabs{display:flex;gap:10px;margin:12px 0 0}
    .tabBtn{
      flex:1;padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:#fff;font-weight:900;color:var(--muted);text-align:center;
    }
    .tabBtn.active{border-color:rgba(249,115,22,.35);color:var(--text);box-shadow:0 8px 18px rgba(249,115,22,.10)}
    .section{display:none}
    .section.active{display:block}

    .mealGrid{display:grid;gap:10px}
    @media(min-width:720px){.mealGrid{grid-template-columns:1fr 1fr}}
    .mealCard{border:1px solid var(--line);border-radius:16px;padding:12px;background:#fff}
    .mealHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .mealTitle{font-weight:950}
    .dayLabel{font-size:12px;color:var(--muted)}
    .check{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);user-select:none}
    .check input{width:22px;height:22px}
    .item{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding:8px 0;border-top:1px dashed var(--line)}
    .item:first-of-type{border-top:none}
    .left{display:flex;gap:10px}
    .icon{width:34px;height:34px;border-radius:12px;background:#FFF7ED;border:1px solid rgba(249,115,22,.18);display:flex;align-items:center;justify-content:center;font-size:18px;flex:0 0 34px}
    .muted{color:var(--muted);font-size:12px;line-height:1.35}
    .tiny{font-size:12px;color:var(--muted)}
    .note{border-left:4px solid var(--orange);background:#FFF7ED;border-radius:12px;padding:10px 12px;color:#7C2D12;font-size:13px;line-height:1.4}
    .footerBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .footerBtns button{flex:1 1 200px}

    .noscript{
      margin:12px 0 0;
      border:1px solid rgba(220,38,38,.25);
      background:rgba(220,38,38,.06);
      color:#7f1d1d;
      border-radius:14px;
      padding:12px;
      font-size:13px;
      line-height:1.4;
    }
    .banner{
      display:none;
      margin-top:10px;
      border:1px solid rgba(255,255,255,.35);
      background:rgba(255,255,255,.16);
      border-radius:14px;
      padding:10px 12px;
      font-size:12px;
      line-height:1.35;
    }
    .banner.show{display:block}

    /* Header motivant */
    .titleLine{display:flex;flex-direction:column;gap:4px}
    .subtitle{font-size:12px;opacity:.95;letter-spacing:.2px}
    .badgeRight{
      min-width:120px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.32);
      background:rgba(255,255,255,.18);
      backdrop-filter: blur(8px);
      text-align:right;
    }
    .badgeLabel{font-size:11px;opacity:.9}
    .badgeValue{font-size:16px;font-weight:950;margin-top:3px}
    .progressWrap{margin-top:12px}
    .progressTop{display:flex;justify-content:space-between;gap:10px;font-size:12px;opacity:.95}
    .progressBar{
      margin-top:8px;
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.22);
      border:1px solid rgba(255,255,255,.25);
      overflow:hidden;
    }
    .progressFill{
      height:100%;
      width:0%;
      border-radius:999px;
      background:rgba(255,255,255,.9);
    }

    /* Historique marche */
    .histCard{border:1px solid var(--line);border-radius:16px;padding:12px;background:#fff}
    .histTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .histTitle{font-weight:950}
    .histMeta{font-size:12px;color:var(--muted);line-height:1.35;margin-top:4px}
    .histBtns{display:flex;gap:8px;margin-top:10px}
    .histBtns button{flex:1}
  </style>
</head>

<body>
<header>
  <div class="top">
    <div class="titleLine">
      <h1 id="headerTitle">üî• D√©fi -30 kg</h1>
      <div class="subtitle" id="headerSubtitle">Chaque jour compte. Tu avances. üí™</div>
    </div>

    <div class="badgeRight">
      <div class="badgeLabel">Poids actuel</div>
      <div class="badgeValue" id="headerPill">‚Äî</div>
    </div>
  </div>

  <div class="progressWrap">
    <div class="progressTop">
      <span id="progressText">Progression</span>
      <span id="progressPct">‚Äî</span>
    </div>
    <div class="progressBar"><div class="progressFill" id="progressFill"></div></div>
  </div>

  <!-- IMPORTANT: tu avais supprim√© cet √©l√©ment, mais ton JS le r√©f√©rence -->
  <div class="banner" id="safariBanner">
    ‚ö†Ô∏è Si tu ouvres ce fichier dans l‚Äôaper√ßu ‚ÄúFichiers‚Äù (Quick Look), les boutons peuvent ne pas marcher.
    Ouvre-le dans <b>Safari</b> (Partager ‚Üí <b>Ouvrir dans Safari</b>) puis ‚ÄúSur l‚Äô√©cran d‚Äôaccueil‚Äù.
  </div>
</header>

<noscript>
  <div class="wrap">
    <div class="noscript">
      JavaScript est d√©sactiv√© : les boutons et le graphique ne peuvent pas fonctionner.
      Ouvre ce fichier dans Safari et active JavaScript.
    </div>
  </div>
</noscript>

<div class="wrap">
  <div class="tabs">
    <button class="tabBtn active" id="tabToday" type="button">Aujourd‚Äôhui</button>
    <button class="tabBtn" id="tabMeals" type="button">Repas</button>
    <button class="tabBtn" id="tabWalk" type="button">Marche</button>
    <button class="tabBtn" id="tabProfile" type="button">Profil</button>
  </div>

  <div class="stack" style="margin-top:12px">
    <section class="section active" id="secToday">
      <div class="card">
        <div class="row" style="align-items:flex-end">
          <div>
            <label>Date</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label>Poids du jour (kg)</label>
            <input id="weight" type="number" step="0.1" inputmode="decimal" placeholder="ex: 114.6" />
          </div>
          <div>
            <button id="saveWeightBtn" type="button">Enregistrer</button>
          </div>
        </div>
        <div class="tiny" style="margin-top:8px">Astuce : pes√©e le matin (apr√®s toilettes) = plus fiable.</div>
      </div>

      <div class="card">
        <div class="kpis">
          <div class="kpi"><div class="t">Poids actuel</div><div class="v" id="kpiWeight">‚Äî</div></div>
          <div class="kpi"><div class="t">Perte totale</div><div class="v" id="kpiLost">‚Äî</div></div>
          <div class="kpi"><div class="t">Moyenne 7 jours</div><div class="v" id="kpiAvg7">‚Äî</div></div>
          <div class="kpi"><div class="t">Objectif</div><div class="v" id="kpiTarget">‚Äî</div></div>
        </div>
        <div style="margin-top:12px">
          <canvas id="chart" width="1000" height="320"></canvas>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px;font-size:15px">üçΩÔ∏è Tes repas d‚Äôaujourd‚Äôhui</h2>
        <div class="mealGrid" id="todayMeals"></div>
      </div>
    </section>

    <section class="section" id="secMeals">
      <div class="card">
        <h2 style="margin:0 0 10px;font-size:15px">üìÖ Repas de la semaine</h2>
        <div class="tiny">Tu peux cocher ‚Äúfait‚Äù jour par jour (optionnel).</div>
        <div class="mealGrid" id="weekMeals" style="margin-top:10px"></div>
        <div class="footerBtns">
          <button class="secondary" id="resetChecksBtn" type="button">R√©initialiser les coches</button>
        </div>
      </div>
    </section>

    <section class="section" id="secWalk">
      <div class="card">
        <h2 style="margin:0 0 10px;font-size:15px">üö∂ Marche (suivi r√©el)</h2>

        <div class="row" style="align-items:flex-end">
          <div>
            <label>Statut</label>
            <input id="walkStatus" type="text" value="Pr√™t" readonly />
          </div>
          <div>
            <label>Temps</label>
            <input id="walkTime" type="text" value="00:00:00" readonly />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Distance</label>
            <input id="walkDistance" type="text" value="0.00 km" readonly />
          </div>
          <div>
            <label>Vitesse moy.</label>
            <input id="walkSpeed" type="text" value="0.0 km/h" readonly />
          </div>
        </div>

        <div class="footerBtns" style="margin-top:10px">
          <button id="walkStartBtn" type="button">‚ñ∂Ô∏è D√©but</button>
          <button class="secondary" id="walkStopBtn" type="button" disabled>‚èπ Fin</button>
          <button class="secondary" id="walkClearBtn" type="button">üóë Effacer la trace</button>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px;font-size:15px">üó∫Ô∏è Carte</h2>
        <div id="walkMap" style="height:320px;border-radius:14px;border:1px solid var(--line);background:#fff;overflow:hidden;display:flex;align-items:center;justify-content:center">
          <div class="tiny" style="padding:14px;text-align:center;max-width:520px">
            La carte utilise OpenStreetMap (Leaflet) charg√© en ligne.
            Hors connexion : le suivi temps/distance marche, mais sans fond de carte.
          </div>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px;font-size:15px">üßæ Historique</h2>
        <div id="walkHistory" class="mealGrid"></div>
        <div class="footerBtns">
          <button class="secondary" id="walkExportBtn" type="button">Exporter (JSON)</button>
          <button class="secondary" id="walkClearAllBtn" type="button">Tout effacer (marches)</button>
        </div>
      </div>
    </section>

    <section class="section" id="secProfile">
      <div class="card">
        <h2 style="margin:0 0 10px;font-size:15px">üë§ Profil (1 fois)</h2>
        <div class="row">
          <div>
            <label>Taille (cm)</label>
            <input id="height" type="number" step="1" inputmode="numeric" placeholder="173" />
          </div>
          <div>
            <label>Poids de d√©part (kg)</label>
            <input id="startWeight" type="number" step="0.1" inputmode="decimal" placeholder="115" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Objectif (kg)</label>
            <input id="targetWeight" type="number" step="0.1" inputmode="decimal" placeholder="85" />
          </div>
          <div>
            <label>Œ©-3 / semaine</label>
            <select id="omegaTarget">
              <option value="2">2 fois</option>
              <option value="3" selected>3 fois</option>
            </select>
          </div>
        </div>

        <div class="footerBtns">
          <button id="saveProfileBtn" type="button">Enregistrer le profil</button>
          <button class="secondary" id="exportBackupBtn" type="button">Backup (JSON)</button>
          <button class="secondary" id="importBackupBtn" type="button">Importer (JSON)</button>
          <button class="secondary" id="clearAllBtn" type="button">Tout effacer</button>
        </div>

        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>
    </section>
  </div>
</div>

<script>
/* ‚úÖ Script robuste "anti page blanche" */
document.addEventListener("DOMContentLoaded", () => {
  // Affiche une alerte claire si une erreur JS arrive
  window.addEventListener("error", (e) => {
    alert("Erreur dans le script :\n" + (e?.message || "inconnue"));
  });

  (function () {
    "use strict";

    // ====== CONFIG ======
    const STORAGE = {
      PROFILE: "defi30_ultra_profile_v2",
      WEIGHTS: "defi30_ultra_weights_v2",
      MEAL_CHECKS: "defi30_ultra_meal_checks_v2",
      WALKS: "defi30_ultra_walks_v1",
      WALK_ACTIVE: "defi30_ultra_walk_active_v1",
    };

    const DEFAULT_PROFILE = { heightCm: 173, startWeight: 115.0, targetWeight: 85.0, omegaTarget: 3 };

    const PROTEINS = ["Poulet","≈íufs","Thon","Skyr","Sardines"];
    const WEEK_PLAN = {
      lunch:  ["Poulet","Poulet","Thon","Poulet","Poulet","Sardines","Poulet"],
      dinner: ["≈íufs","Skyr","≈íufs","Thon","Skyr","≈íufs","Sardines"]
    };
    const MEAL_DEFAULTS = { lunchSoupMl:700, dinnerSoupMl:450 };

    const MOTIVATION = [
      "Chaque jour compte. Tu avances. üí™",
      "Discipline aujourd‚Äôhui. Fiert√© demain. üî•",
      "Pas besoin d‚Äô√™tre parfait, juste constant. ‚úÖ",
      "1% mieux chaque jour. üöÄ",
    ];

    const GPS_OPTS = { enableHighAccuracy:true, maximumAge:1000, timeout:20000 };

    // ====== UI helpers ======
    const $ = (id)=>document.getElementById(id);
    const exists = (id)=>!!document.getElementById(id);

    function setText(id, txt){ const el=$(id); if(el) el.textContent = txt; }
    function setHTML(id, html){ const el=$(id); if(el) el.innerHTML = html; }
    function toggleActive(id, on){ const el=$(id); if(el) el.classList.toggle("active", !!on); }

    // ====== data helpers ======
    function loadJSON(key, fallback){
      try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
      catch{ return fallback; }
    }
    function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
    function del(key){ localStorage.removeItem(key); }

    function downloadText(filename, text, mime){
      const blob=new Blob([text], {type:mime||"text/plain;charset=utf-8"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download=filename;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // ====== small utils ======
    function isoToday(){
      const d=new Date(); const tz=d.getTimezoneOffset()*60000;
      return new Date(d - tz).toISOString().slice(0,10);
    }
    function addDays(iso,n){
      const d=new Date(iso+"T00:00:00"); d.setDate(d.getDate()+n);
      const tz=d.getTimezoneOffset()*60000;
      return new Date(d - tz).toISOString().slice(0,10);
    }
    function dayName(iso){
      const d=new Date(iso+"T00:00:00");
      return ["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"][d.getDay()];
    }
    function fmt(n,d=1){
      if(n===null||n===undefined||n==="") return "‚Äî";
      const x=Number(n); if(Number.isNaN(x)) return "‚Äî";
      return x.toFixed(d);
    }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function fmtHMS(ms){
      const s=Math.max(0, Math.floor(ms/1000));
      const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60;
      return `${pad2(h)}:${pad2(m)}:${pad2(ss)}`;
    }

    function haversineMeters(a,b){
      const R=6371000;
      const toRad=(x)=>x*Math.PI/180;
      const dLat=toRad(b.lat-a.lat);
      const dLon=toRad(b.lng-a.lng);
      const lat1=toRad(a.lat), lat2=toRad(b.lat);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2);
      const h=s1*s1 + Math.cos(lat1)*Math.cos(lat2)*s2*s2;
      return 2*R*Math.asin(Math.min(1, Math.sqrt(h)));
    }

    // ====== Tabs ======
    function setTab(which){
      const tabs=[["tabToday","secToday"],["tabMeals","secMeals"],["tabWalk","secWalk"],["tabProfile","secProfile"]];
      tabs.forEach(([t,s])=>{
        toggleActive(t, t===which);
        toggleActive(s, t===which);
      });
    }

    // ====== Meals ======
    function mealCard(dateISO, mealType){
      const checks = loadJSON(STORAGE.MEAL_CHECKS, {});
      const key = dateISO + "_" + mealType;
      const done = !!checks[key];

      const weekday = new Date(dateISO+"T00:00:00").getDay();
      const protein = mealType==="lunch" ? WEEK_PLAN.lunch[weekday] : WEEK_PLAN.dinner[weekday];
      const title = mealType==="lunch" ? "Midi" : "Soir";
      const soupMl = mealType==="lunch" ? MEAL_DEFAULTS.lunchSoupMl : MEAL_DEFAULTS.dinnerSoupMl;

      const el=document.createElement("div");
      el.className="mealCard";
      el.innerHTML = `
        <div class="mealHead">
          <div>
            <div class="mealTitle">${title}</div>
            <div class="dayLabel">${dayName(dateISO)} ‚Ä¢ ${dateISO}</div>
          </div>
          <label class="check"><input type="checkbox" ${done?"checked":""}/>fait</label>
        </div>

        <div class="item">
          <div class="left">
            <div class="icon">ü•£</div>
            <div><b>Soupe maison</b><div class="muted">${soupMl} ml</div></div>
          </div>
        </div>

        <div class="item">
          <div class="left">
            <div class="icon">üçó</div>
            <div><b>Prot√©ines</b><div class="muted">${mealType==="lunch" ? "‚âà 200 g" : "portion l√©g√®re"}</div></div>
          </div>
          <div style="min-width:120px">
            <select aria-label="Prot√©ines">
              ${PROTEINS.map(p=>`<option value="${p}" ${p===protein?"selected":""}>${p}</option>`).join("")}
            </select>
          </div>
        </div>

        ${mealType==="lunch" ? `
        <div class="item">
          <div class="left">
            <div class="icon">ü´í</div>
            <div><b>Huile d‚Äôolive</b><div class="muted">1 c. √† caf√©</div></div>
          </div>
        </div>` : ""}
      `;

      const cb = el.querySelector('input[type="checkbox"]');
      cb.addEventListener("change", ()=>{
        const st=loadJSON(STORAGE.MEAL_CHECKS,{});
        st[key]=cb.checked;
        saveJSON(STORAGE.MEAL_CHECKS, st);
      });
      return el;
    }

    // ====== Weights ======
    function loadWeights(){
      const rows = loadJSON(STORAGE.WEIGHTS, []);
      return Array.isArray(rows) ? rows.filter(r=>r && r.date).sort((a,b)=>a.date.localeCompare(b.date)) : [];
    }
    function saveWeight(dateISO, weight){
      const rows = loadWeights();
      const idx = rows.findIndex(r=>r.date===dateISO);
      const row = {date:dateISO, weight:Number(weight)};
      if(idx>=0) rows[idx]=row; else rows.push(row);
      rows.sort((a,b)=>a.date.localeCompare(b.date));
      saveJSON(STORAGE.WEIGHTS, rows);
    }
    function computeStats(profile, rows){
      const withW=rows.filter(r=>typeof r.weight==="number");
      const current=withW.length ? withW[withW.length-1].weight : null;
      const lost=(current!=null) ? (profile.startWeight - current) : null;
      const last7=withW.slice(-7).map(r=>r.weight);
      const avg7=last7.length ? last7.reduce((a,b)=>a+b,0)/last7.length : null;
      return {current, lost, avg7};
    }

    function drawChart(rows){
      const c=$("chart");
      if(!c) return;
      const ctx=c.getContext("2d");
      const W=c.width, H=c.height; ctx.clearRect(0,0,W,H);

      const pts=rows.filter(r=>typeof r.weight==="number")
        .map(r=>({x:new Date(r.date).getTime(), y:r.weight}))
        .sort((a,b)=>a.x-b.x);

      const padL=52,padR=14,padT=16,padB=30;
      ctx.strokeStyle="rgba(229,231,235,1)";
      ctx.lineWidth=1;
      ctx.strokeRect(padL,padT,W-padL-padR,H-padT-padB);

      ctx.fillStyle="rgba(107,114,128,1)";
      ctx.font="14px system-ui";
      if(pts.length<2){
        ctx.fillText("Ajoute 2 pes√©es pour voir la courbe.", padL+12, padT+28);
        return;
      }

      const minX=pts[0].x, maxX=pts[pts.length-1].x;
      const ys=pts.map(p=>p.y);
      let minY=Math.min(...ys), maxY=Math.max(...ys);
      const margin=Math.max(0.8,(maxY-minY)*0.15);
      minY-=margin; maxY+=margin;

      const plotW=W-padL-padR, plotH=H-padT-padB;
      const xToPx=x=>padL+((x-minX)/(maxX-minX))*plotW;
      const yToPx=y=>padT+(1-((y-minY)/(maxY-minY)))*plotH;

      ctx.strokeStyle="rgba(229,231,235,1)";
      ctx.fillStyle="rgba(107,114,128,1)";
      ctx.font="12px system-ui";
      for(let i=0;i<=4;i++){
        const t=i/4;
        const yVal=maxY-t*(maxY-minY);
        const y=yToPx(yVal);
        ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
        ctx.fillText(yVal.toFixed(1), 10, y+4);
      }

      ctx.strokeStyle="rgba(249,115,22,1)";
      ctx.lineWidth=2.6;
      ctx.beginPath();
      pts.forEach((p,i)=>{
        const x=xToPx(p.x), y=yToPx(p.y);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      ctx.fillStyle="rgba(249,115,22,1)";
      pts.forEach(p=>{
        const x=xToPx(p.x), y=yToPx(p.y);
        ctx.beginPath(); ctx.arc(x,y,3.2,0,Math.PI*2); ctx.fill();
      });
    }

    // ====== Walk ======
    let watchId=null, timerId=null;
    let walkMap=null, walkLine=null, walkMarker=null;

    function getActiveWalk(){ return loadJSON(STORAGE.WALK_ACTIVE, null); }
    function setActiveWalk(w){ if(!w) del(STORAGE.WALK_ACTIVE); else saveJSON(STORAGE.WALK_ACTIVE, w); }
    function loadWalks(){ const rows = loadJSON(STORAGE.WALKS, []); return Array.isArray(rows)?rows:[]; }
    function saveWalks(rows){ saveJSON(STORAGE.WALKS, rows); }

    function stopWatchAndTimer(){
      if(watchId!=null){ try{ navigator.geolocation.clearWatch(watchId); }catch{} watchId=null; }
      if(timerId!=null){ clearInterval(timerId); timerId=null; }
    }

    function ensureLeafletMap(){
      const box = $("walkMap");
      if(!box) return;
      if(typeof L==="undefined") return; // offline / bloqu√©
      if(walkMap) return;

      walkMap = L.map(box, { zoomControl:true });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom:19,
        attribution:"&copy; OpenStreetMap"
      }).addTo(walkMap);

      walkLine = L.polyline([], { weight:5 }).addTo(walkMap);
    }

    function renderWalkOnMap(points, fit=true){
      ensureLeafletMap();
      if(!walkMap || typeof L==="undefined") return;
      if(!points?.length) return;

      const latlngs = points.map(p=>[p.lat,p.lng]);
      walkLine.setLatLngs(latlngs);

      const last=points[points.length-1];
      if(!walkMarker) walkMarker = L.circleMarker([last.lat,last.lng], { radius:6, weight:2 }).addTo(walkMap);
      walkMarker.setLatLng([last.lat,last.lng]);

      if(fit){
        try{
          const bounds = L.latLngBounds(latlngs);
          walkMap.fitBounds(bounds, { padding:[20,20] });
        }catch{}
      }
    }

    function renderWalkStats(w){
      if(!exists("walkStatus")) return;
      const now=Date.now();
      const elapsed = w?.active ? (now - w.startedAt) : (w?.elapsedMs || 0);
      const distM = w?.distanceM || 0;

      $("walkStatus").value = w?.active ? "En cours‚Ä¶" : "Pr√™t";
      $("walkTime").value = fmtHMS(elapsed);
      $("walkDistance").value = (distM/1000).toFixed(2) + " km";

      const hours = elapsed/3600000;
      const km = distM/1000;
      const speed = hours>0 ? (km/hours) : 0;
      $("walkSpeed").value = speed.toFixed(1) + " km/h";

      $("walkStartBtn").disabled = !!w?.active;
      $("walkStopBtn").disabled  = !w?.active;
    }

    function renderWalkHistory(){
      const box=$("walkHistory");
      if(!box) return;

      const walks=loadWalks();
      if(!walks.length){
        box.innerHTML = `<div class="tiny">Aucune marche enregistr√©e pour l‚Äôinstant.</div>`;
        return;
      }

      box.innerHTML = "";
      walks.slice(0,20).forEach(w=>{
        const date = new Date(w.startedAt || Date.now());
        const d = date.toLocaleDateString("fr-FR", { weekday:"short", year:"numeric", month:"short", day:"numeric" });
        const t = date.toLocaleTimeString("fr-FR", { hour:"2-digit", minute:"2-digit" });

        const km = ((w.distanceM||0)/1000);
        const h = ((w.elapsedMs||0)/3600000);
        const v = (h>0) ? (km/h) : 0;

        const el=document.createElement("div");
        el.className="histCard";
        el.innerHTML = `
          <div class="histTop">
            <div>
              <div class="histTitle">Marche ‚Ä¢ ${d}</div>
              <div class="histMeta">
                D√©but : ${t}<br>
                Dur√©e : ${fmtHMS(w.elapsedMs||0)} ‚Ä¢ Distance : ${km.toFixed(2)} km ‚Ä¢ Vitesse moy : ${v.toFixed(1)} km/h
              </div>
            </div>
            <div class="tiny">${(w.points?.length||0)} pts</div>
          </div>
          <div class="histBtns">
            <button class="secondary" type="button" data-view="${w.id}">Voir</button>
            <button class="secondary" type="button" data-del="${w.id}">Supprimer</button>
          </div>
        `;
        box.appendChild(el);
      });

      box.querySelectorAll("[data-view]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id=btn.getAttribute("data-view");
          const w=loadWalks().find(x=>x.id===id);
          if(!w?.points?.length){ alert("Aucun point GPS."); return; }
          setTab("tabWalk");
          setTimeout(()=>renderWalkOnMap(w.points,true), 50);
        });
      });
      box.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id=btn.getAttribute("data-del");
          if(!confirm("Supprimer cette marche ?")) return;
          saveWalks(loadWalks().filter(w=>w.id!==id));
          renderWalkUI();
        });
      });
    }

    function renderWalkUI(skipFit=false){
      const cur=getActiveWalk();
      renderWalkStats(cur || {active:false, elapsedMs:0, distanceM:0});
      if(cur?.points?.length) renderWalkOnMap(cur.points, !skipFit);
      renderWalkHistory();
    }

    function startWalk(){
      if(!navigator.geolocation){ alert("G√©olocalisation non disponible."); return; }
      if(getActiveWalk()?.active){ alert("Une marche est d√©j√† en cours."); return; }

      const w={ id:"walk_"+Date.now(), active:true, startedAt:Date.now(), elapsedMs:0, distanceM:0, points:[] };
      setActiveWalk(w);
      renderWalkUI();

      watchId = navigator.geolocation.watchPosition((pos)=>{
        const cur=getActiveWalk();
        if(!cur?.active) return;

        const p={ t:Date.now(), lat:pos.coords.latitude, lng:pos.coords.longitude, acc:pos.coords.accuracy };

        if(typeof p.acc==="number" && p.acc>60){
          if(cur.points.length>0) return;
        }

        const last=cur.points[cur.points.length-1];
        if(last){
          const d=haversineMeters({lat:last.lat,lng:last.lng},{lat:p.lat,lng:p.lng});
          if(d>150) return;
          cur.distanceM += d;
        }
        cur.points.push(p);
        setActiveWalk(cur);
        renderWalkUI(true);
      }, (err)=>{
        let msg="Erreur GPS.";
        if(err?.code===1) msg="Permission refus√©e : autorise Position dans Safari.";
        if(err?.code===2) msg="Position indisponible (essaie dehors).";
        if(err?.code===3) msg="Timeout GPS (r√©essaie).";
        alert(msg);
        renderWalkUI();
      }, GPS_OPTS);

      timerId = setInterval(()=>{
        if(getActiveWalk()?.active) renderWalkUI(true);
      }, 1000);
    }

    function stopWalk(){
      const cur=getActiveWalk();
      if(!cur?.active){ alert("Aucune marche en cours."); return; }

      cur.active=false;
      cur.endedAt=Date.now();
      cur.elapsedMs = cur.endedAt - cur.startedAt;

      const walks=loadWalks();
      walks.unshift(cur);
      saveWalks(walks);

      setActiveWalk(null);
      stopWatchAndTimer();
      renderWalkUI();
      alert("Marche enregistr√©e ‚úÖ");
    }

    function clearActiveTrace(){
      const cur=getActiveWalk();
      if(cur?.active){
        if(!confirm("Effacer la trace de la marche en cours ?")) return;
        cur.points=[]; cur.distanceM=0;
        setActiveWalk(cur);
        renderWalkUI();
        return;
      }
      if(!confirm("Effacer la trace affich√©e sur la carte (sans toucher √† l‚Äôhistorique) ?")) return;
      if(walkLine) walkLine.setLatLngs([]);
      if(walkMarker && walkMap){ try{ walkMap.removeLayer(walkMarker);}catch{} walkMarker=null; }
      renderWalkUI();
    }

    function exportWalks(){
      const payload={ version:1, exportedAt:new Date().toISOString(), walks:loadWalks() };
      downloadText("defi30_marches.json", JSON.stringify(payload,null,2), "application/json;charset=utf-8");
    }

    function clearAllWalks(){
      if(!confirm("Tout effacer : historique des marches ?")) return;
      del(STORAGE.WALKS);
      setActiveWalk(null);
      stopWatchAndTimer();
      renderWalkUI();
    }

    function initWalkUI(){
      if(exists("walkStartBtn")){
        $("walkStartBtn").onclick = startWalk;
        $("walkStopBtn").onclick  = stopWalk;
        $("walkClearBtn").onclick = clearActiveTrace;
        $("walkExportBtn").onclick = exportWalks;
        $("walkClearAllBtn").onclick = clearAllWalks;
      }

      // reprise si marche active
      const cur=getActiveWalk();
      if(cur?.active && navigator.geolocation){
        if(timerId==null){
          timerId=setInterval(()=>{ if(getActiveWalk()?.active) renderWalkUI(true); }, 1000);
        }
        if(watchId==null){
          watchId = navigator.geolocation.watchPosition(()=>{}, ()=>{}, GPS_OPTS);
          // ‚ö†Ô∏è on ne duplique pas la logique ici : startWalk g√®re le vrai suivi.
          // Si tu veux une reprise parfaite apr√®s refresh, dis-moi et je te le fais.
          try{ navigator.geolocation.clearWatch(watchId); }catch{}
          watchId=null;
          // On relance proprement en demandant au user de retoucher "D√©but"
        }
      }

      renderWalkUI();
    }

    // ====== Render global ======
    function render(){
      // profile
      let profile=loadJSON(STORAGE.PROFILE, null);
      if(!profile){ profile=DEFAULT_PROFILE; saveJSON(STORAGE.PROFILE, profile); }

      // weights
      const rows=loadWeights();
      const dateISO = $("date")?.value || isoToday();
      const current = rows.filter(r=>typeof r.weight==="number").slice(-1)[0]?.weight ?? null;

      // header subtitle motivant
      if(exists("headerSubtitle")){
        const idx = Math.floor(Date.now()/(10*60*1000)) % MOTIVATION.length;
        setText("headerSubtitle", MOTIVATION[idx]);
      }

      // header badge
      if(exists("headerPill")){
        setText("headerPill", current!=null ? `${fmt(current,1)} kg` : `${fmt(profile.targetWeight,1)} kg`);
      }

      // progress
      if(exists("progressFill") && exists("progressPct") && exists("progressText")){
        const sw=Number(profile.startWeight);
        const tw=Number(profile.targetWeight);
        if(!Number.isNaN(sw) && !Number.isNaN(tw) && current!=null){
          const total=(sw-tw);
          const done=(sw-current);
          let pct = total>0 ? (done/total)*100 : 0;
          pct = Math.max(0, Math.min(100, pct));
          $("progressFill").style.width = pct.toFixed(0) + "%";
          setText("progressPct", pct.toFixed(0) + "%");
          setText("progressText", "Vers ton objectif");
        }else{
          $("progressFill").style.width = "0%";
          setText("progressPct", "‚Äî");
          setText("progressText", "Progression");
        }
      }

      const s=computeStats(profile, rows);
      setText("kpiWeight", s.current!=null ? fmt(s.current,1)+" kg" : "‚Äî");
      setHTML("kpiLost", s.lost!=null ? `<span class="${s.lost>=0?'pos':'neg'}">${fmt(s.lost,1)} kg</span>` : "‚Äî");
      setText("kpiAvg7", s.avg7!=null ? fmt(s.avg7,1)+" kg" : "‚Äî");
      setText("kpiTarget", fmt(profile.targetWeight,1)+" kg");

      // fill weight input if exists
      const existing = rows.find(r=>r.date===dateISO);
      if(existing && exists("weight")){
        if($("weight").value==="" || $("weight").dataset.autofill==="1"){
          $("weight").value = existing.weight;
          $("weight").dataset.autofill="1";
        }
      }

      drawChart(rows);

      // meals
      if(exists("todayMeals")){
        $("todayMeals").innerHTML="";
        $("todayMeals").appendChild(mealCard(dateISO,"lunch"));
        $("todayMeals").appendChild(mealCard(dateISO,"dinner"));
      }
      if(exists("weekMeals")){
        $("weekMeals").innerHTML="";
        for(let i=0;i<7;i++){
          const d=addDays(isoToday(), i);
          $("weekMeals").appendChild(mealCard(d,"lunch"));
          $("weekMeals").appendChild(mealCard(d,"dinner"));
        }
      }

      // profile fields
      if(exists("height")) $("height").value = profile.heightCm ?? "";
      if(exists("startWeight")) $("startWeight").value = profile.startWeight ?? "";
      if(exists("targetWeight")) $("targetWeight").value = profile.targetWeight ?? "";
      if(exists("omegaTarget")) $("omegaTarget").value = String(profile.omegaTarget ?? 3);

      // walk refresh
      renderWalkUI();
    }

    // ====== Events ======
    $("tabToday")?.addEventListener("click", ()=>setTab("tabToday"));
    $("tabMeals")?.addEventListener("click", ()=>setTab("tabMeals"));
    $("tabWalk")?.addEventListener("click", ()=>{ setTab("tabWalk"); initWalkUI(); });
    $("tabProfile")?.addEventListener("click", ()=>setTab("tabProfile"));

    $("date")?.addEventListener("change", ()=>{
      if(exists("weight")){
        $("weight").dataset.autofill="1";
        $("weight").value="";
      }
      render();
    });

    $("saveWeightBtn")?.addEventListener("click", ()=>{
      const d=$("date")?.value;
      const w=$("weight")?.value ? Number($("weight").value) : null;
      if(!d){ alert("Choisis une date."); return; }
      if(w===null || Number.isNaN(w)){ alert("Entre ton poids."); return; }
      saveWeight(d,w);
      if(exists("weight")) $("weight").dataset.autofill="0";
      render();
      alert("Poids enregistr√© ‚úÖ");
    });

    $("saveProfileBtn")?.addEventListener("click", ()=>{
      const p={
        heightCm: $("height")?.value ? Number($("height").value) : null,
        startWeight: $("startWeight")?.value ? Number($("startWeight").value) : null,
        targetWeight: $("targetWeight")?.value ? Number($("targetWeight").value) : null,
        omegaTarget: $("omegaTarget")?.value ? Number($("omegaTarget").value) : 3
      };
      if(!p.startWeight || !p.targetWeight){ alert("Remplis poids de d√©part et objectif."); return; }
      saveJSON(STORAGE.PROFILE, p);
      render();
      setTab("tabToday");
      alert("Profil enregistr√© ‚úÖ");
    });

    $("resetChecksBtn")?.addEventListener("click", ()=>{
      if(!confirm("R√©initialiser toutes les coches repas ?")) return;
      del(STORAGE.MEAL_CHECKS);
      render();
    });

    $("exportBackupBtn")?.addEventListener("click", ()=>{
      const payload={
        version:3,
        exportedAt:new Date().toISOString(),
        profile: loadJSON(STORAGE.PROFILE, DEFAULT_PROFILE),
        weights: loadWeights(),
        mealChecks: loadJSON(STORAGE.MEAL_CHECKS, {}),
        walks: loadWalks()
      };
      downloadText("defi30_backup_ultra_simple.json", JSON.stringify(payload,null,2), "application/json;charset=utf-8");
    });

    $("importBackupBtn")?.addEventListener("click", ()=> $("importFile")?.click());

    $("importFile")?.addEventListener("change", async (e)=>{
      const f=e.target.files?.[0];
      if(!f) return;
      const text=await f.text();
      try{
        const payload=JSON.parse(text);
        if(!payload || !Array.isArray(payload.weights)) throw new Error("Format invalide");
        if(!confirm("Importer ce backup et remplacer tes donn√©es ?")) return;

        if(payload.profile) saveJSON(STORAGE.PROFILE, payload.profile);
        saveJSON(STORAGE.WEIGHTS, payload.weights);
        if(payload.mealChecks) saveJSON(STORAGE.MEAL_CHECKS, payload.mealChecks);
        if(payload.walks) saveJSON(STORAGE.WALKS, payload.walks);

        setActiveWalk(null);
        stopWatchAndTimer();

        render();
        alert("Import termin√© ‚úÖ");
      }catch(err){
        alert("Import √©chou√© : " + err.message);
      }finally{ e.target.value=""; }
    });

    $("clearAllBtn")?.addEventListener("click", ()=>{
      if(!confirm("Tout effacer (profil + poids + coches + marches) ?")) return;
      del(STORAGE.PROFILE);
      del(STORAGE.WEIGHTS);
      del(STORAGE.MEAL_CHECKS);
      del(STORAGE.WALKS);
      setActiveWalk(null);
      stopWatchAndTimer();
      if(exists("weight")) $("weight").value="";
      render();
      alert("Donn√©es effac√©es.");
    });

    // ====== INIT ======
    if(exists("date")) $("date").value = isoToday();

    // banni√®re iOS (si pr√©sent)
    try{
      const isIOS=/iPhone|iPad|iPod/i.test(navigator.userAgent);
      if(isIOS && exists("safariBanner")) $("safariBanner").classList.add("show");
    }catch{}

    render();
  })();
});
</script>

</body>
</html>
