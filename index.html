<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Coach Sant√© ‚Äî D√©fi</title>
  <meta name="theme-color" content="#0B0B10" />

  <!-- Leaflet (carte marche) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg0:#05050A;
      --bg1:#0B0B10;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.45);

      --accent:#FF2D55;
      --accent2:#FF9F0A;
      --good:#30D158;
      --bad:#FF453A;

      --shadow: 0 22px 80px rgba(0,0,0,.55);
      --r: 22px;

      --safeTop: env(safe-area-inset-top);
      --safeBot: env(safe-area-inset-bottom);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text",system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 18% -10%, rgba(255,45,85,.20), transparent 55%),
        radial-gradient(900px 600px at 85% 0%, rgba(255,159,10,.14), transparent 55%),
        radial-gradient(900px 600px at 70% 90%, rgba(48,209,88,.10), transparent 50%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      -webkit-font-smoothing: antialiased;
      overflow-x:hidden;
    }

    /* ===== Header ===== */
    header{
      position:sticky; top:0; z-index:80;
      padding: calc(10px + var(--safeTop)) 14px 12px;
      background: linear-gradient(180deg, rgba(10,10,14,.88), rgba(10,10,14,.60));
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .headerInner{max-width:980px;margin:0 auto}
    .headTop{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .title{margin:0;font-size:34px;letter-spacing:-.8px;font-weight:950;line-height:1.06}
    .subtitle{margin-top:6px;font-size:13px;color:var(--muted);max-width:560px}

    .miniStats{
      display:flex;flex-direction:column;gap:8px;align-items:flex-end;
      min-width:150px;flex:0 0 auto;
    }
    .pill{
      width:100%;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      text-align:right;
    }
    .pill .l{font-size:12px;color:var(--muted2)}
    .pill .v{margin-top:3px;font-weight:950;font-size:17px;white-space:nowrap}

    .badgesRow{
      display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .badge strong{color:var(--text)}
    .badge.good{border-color:rgba(48,209,88,.22);background:rgba(48,209,88,.08)}
    .badge.pink{border-color:rgba(255,45,85,.22);background:rgba(255,45,85,.08)}
    .badge.warn{border-color:rgba(255,159,10,.22);background:rgba(255,159,10,.08)}

    /* ===== Layout ===== */
    .wrap{
      max-width:980px;margin:0 auto;
      padding:14px 14px calc(140px + var(--safeBot));
    }
    .stack{display:grid;gap:12px}
    .section{display:none}
    .section.active{display:block}

    .card{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
      overflow:hidden;
    }
    .cardTitle{
      margin:0;
      font-size:20px;
      letter-spacing:-.3px;
      font-weight:950;
    }
    .tiny{font-size:12px;color:var(--muted);line-height:1.35}
    .muted{color:var(--muted);font-size:12px;line-height:1.35}

    /* ===== Dashboard / Snapshot ===== */
    .snapshotGrid{
      display:grid;
      grid-template-columns: 1.25fr 1fr;
      gap:12px;
      align-items:stretch;
    }
    @media(max-width:820px){
      .snapshotGrid{grid-template-columns:1fr}
    }
    .coachTop{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
    }
    .coachName{
      display:flex;align-items:center;gap:10px;
      font-weight:950;letter-spacing:-.2px;
    }
    .coachAvatar{
      width:40px;height:40px;border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      background: radial-gradient(200px 100px at 20% 20%, rgba(255,45,85,.25), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 16px 45px rgba(0,0,0,.45);
      flex:0 0 40px;
    }
    .coachBubble{
      margin-top:10px;
      padding:12px 12px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(520px 220px at 15% 30%, rgba(255,45,85,.18), rgba(255,255,255,.04));
    }
    .coachMsg{
      color: rgba(255,255,255,.84);
      font-size:13px;
      line-height:1.45;
    }

    .statsTiles{
      display:grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap:10px;
    }
    .tile{
      border-radius:20px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:12px;
      min-width:0;
    }
    .tile .t{font-size:12px;color:var(--muted2)}
    .tile .v{
      margin-top:6px;font-size:18px;font-weight:950;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .pos{color:var(--good)} .neg{color:var(--bad)}
    .tile .s{margin-top:6px;font-size:12px;color:var(--muted)}

    .bar{
      margin-top:8px;height:10px;border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      border-radius:999px;
      background: rgba(255,255,255,.75);
    }

    /* ===== Missions ===== */
    .missionGrid{
      margin-top:12px;
      display:grid;gap:10px;
    }
    .task{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      padding:12px;border-radius:20px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
    }
    .taskLeft{display:flex;gap:10px;min-width:0}
    .taskIco{
      width:40px;height:40px;border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 40px;
    }
    .taskName{font-weight:950}
    .taskHint{margin-top:4px;font-size:12px;color:rgba(255,255,255,.62);line-height:1.35}
    .taskRight{display:flex;flex-direction:column;align-items:flex-end;gap:8px;flex:0 0 auto}
    .task input{width:24px;height:24px;accent-color: var(--accent)}
    .xpTag{
      font-size:12px;color:rgba(255,255,255,.72);
      padding:6px 9px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      white-space:nowrap;
    }

    /* ===== Quick log ===== */
    .quickLog{
      display:grid;
      grid-template-columns: repeat(3,minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    @media(max-width:820px){.quickLog{grid-template-columns:1fr}}
    .logCard{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius:22px;
      padding:12px;
    }
    .logTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .logTop .name{font-weight:950}
    .logTop .val{color:var(--muted)}
    .logBtns{display:flex;gap:10px;margin-top:10px}
    .logBtns button{padding:10px 10px;border-radius:18px}
    .miniInput{
      margin-top:10px;
      display:flex;gap:10px;align-items:center;
    }
    .miniInput input[type="number"]{max-width:120px}
    .miniInput input[type="range"]{width:100%}

    /* ===== Forms ===== */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:560px){.grid2{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted2);margin-bottom:6px}

    input,select,textarea,button{
      width:100%;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 12px;
      font-size:16px;
      outline:none;
    }
    input::placeholder, textarea::placeholder{color:rgba(255,255,255,.40)}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(255,45,85,.45);
      box-shadow: 0 0 0 3px rgba(255,45,85,.16);
    }

    .primary{
      border:none;
      background: linear-gradient(180deg, rgba(255,45,85,1), rgba(255,45,85,.78));
      font-weight:950;
      box-shadow: 0 22px 60px rgba(255,45,85,.22);
      cursor:pointer;
    }
    .secondary{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-weight:900;
      cursor:pointer;
    }
    button:disabled{opacity:.55;cursor:not-allowed;box-shadow:none}

    /* ===== Seg range ===== */
    .seg{
      display:flex;gap:8px;
      padding:6px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      margin-top:12px;
    }
    .seg button{
      border:none;background:transparent;
      padding:10px 10px;
      border-radius:14px;
      color:var(--muted);
      font-weight:900;cursor:pointer;
    }
    .seg button.active{
      background: rgba(255,255,255,.10);
      color:var(--text);
      box-shadow: 0 18px 44px rgba(0,0,0,.45);
    }

    /* ===== Chart ===== */
    canvas{
      width:100%;
      height:250px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      display:block;
      margin-top:12px;
    }

    /* ===== Meals ===== */
    .mealGrid{display:grid;gap:12px;margin-top:12px}
    @media(min-width:820px){.mealGrid{grid-template-columns:1fr 1fr}}
    .mealCard{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius:22px;
      padding:14px;
      min-width:0;
    }
    .mealHead{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px}
    .mealTitle{font-weight:950;font-size:18px}
    .dayLabel{font-size:12px;color:var(--muted)}
    .check{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);user-select:none}
    .check input{width:24px;height:24px;accent-color:var(--accent)}
    .item{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      padding:10px 0;border-top:1px dashed rgba(255,255,255,.12)
    }
    .item:first-of-type{border-top:none}
    .left{display:flex;gap:10px;min-width:0}
    .icon{
      width:40px;height:40px;border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(255,45,85,.10);
      border:1px solid rgba(255,45,85,.16);
      flex:0 0 40px;
    }
    .selectWrap{min-width:150px}

    /* ===== Walk ===== */
    #walkMap{
      height:320px;border-radius:20px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      overflow:hidden;
    }
    .histCard{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius:22px;
      padding:14px;
    }
    .histTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .histTitle{font-weight:950}
    .histMeta{margin-top:6px;font-size:12px;color:var(--muted);line-height:1.35}
    .histBtns{display:flex;gap:10px;margin-top:12px}
    .histBtns button{flex:1}

    /* ===== Toasts ===== */
    .toasts{
      position:fixed;
      right:14px;
      bottom: calc(88px + var(--safeBot));
      width:min(380px, calc(100vw - 28px));
      z-index:9999;
      display:flex;flex-direction:column;gap:10px;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      border-radius:22px;
      padding:12px;
      background: rgba(15,15,18,.92);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 24px 80px rgba(0,0,0,.65);
      display:flex;gap:10px;align-items:flex-start;
      transform: translateY(8px); opacity:0;
      animation: toastIn .18s ease forwards;
    }
    @keyframes toastIn{to{transform:translateY(0);opacity:1}}
    .toast .ico{
      width:38px;height:38px;border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(255,45,85,.14);
      border:1px solid rgba(255,45,85,.20);
      flex:0 0 38px;
    }
    .toast.good .ico{background: rgba(48,209,88,.14); border-color: rgba(48,209,88,.22)}
    .toast.bad  .ico{background: rgba(255,69,58,.14); border-color: rgba(255,69,58,.22)}
    .toast .title{font-weight:950}
    .toast .msg{margin-top:2px;font-size:12px;color:rgba(255,255,255,.72);line-height:1.35}
    .toast .x{margin-left:auto;background:transparent;border:none;width:auto;padding:0;color:rgba(255,255,255,.55);font-weight:950;cursor:pointer}

    /* ===== Bottom nav ===== */
    .bottomNav{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom: calc(10px + var(--safeBot));
      width:min(700px, calc(100vw - 24px));
      z-index:90;
      padding:10px;
      border-radius:26px;
      background: rgba(15,15,18,.78);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      box-shadow: 0 26px 90px rgba(0,0,0,.72);
    }
    .navGrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .navBtn{
      border:none;border-radius:18px;
      padding:10px 8px;
      background:transparent;
      color:rgba(255,255,255,.70);
      font-weight:900;
      cursor:pointer;
      display:flex;flex-direction:column;gap:6px;
      align-items:center;justify-content:center;
    }
    .navBtn .ico{font-size:18px;line-height:1}
    .navBtn.active{
      background: radial-gradient(240px 120px at 50% 20%, rgba(255,45,85,.22), rgba(255,255,255,.04));
      border:1px solid rgba(255,45,85,.25);
      color:var(--text);
    }

    .leaflet-control-attribution{display:none}
  </style>
</head>

<body>
<header>
  <div class="headerInner">
    <div class="headTop">
      <div>
        <h1 class="title">Coach</h1>
        <div class="subtitle" id="headerSubtitle">Objectif : gagner ta journ√©e (2/3). Simple, faisable, sans sport.</div>
      </div>

      <div class="miniStats">
        <div class="pill">
          <div class="l">Poids actuel</div>
          <div class="v" id="headerWeight">‚Äî</div>
        </div>
        <div class="badgesRow">
          <span class="badge pink">üî• S√©rie: <strong id="badgeStreak">‚Äî</strong></span>
          <span class="badge warn">‚ö° XP: <strong id="badgeXP">‚Äî</strong></span>
          <span class="badge good">üèÖ Niveau: <strong id="badgeLevel">‚Äî</strong></span>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="toasts" id="toasts"></div>

<div class="wrap">
  <div class="stack">

    <!-- ===== R√©sum√© ===== -->
    <section class="section active" id="secSummary">
      <div class="card">
        <div class="snapshotGrid">
          <!-- Coach -->
          <div>
            <div class="coachTop">
              <div class="coachName">
                <div class="coachAvatar">üôÇ</div>
                <div>
                  <div style="font-size:18px;font-weight:950;letter-spacing:-.2px">R√©sum√© du jour</div>
                  <div class="tiny" id="dailyScore">Score : ‚Äî</div>
                </div>
              </div>
              <span class="badge" id="todayBadge">üéØ Objectif: ‚Äî</span>
            </div>

            <div class="coachBubble">
              <div class="coachMsg" id="coachMsg">‚Äî</div>
            </div>

            <div class="missionGrid" id="missions"></div>
          </div>

          <!-- Tiles -->
          <div>
            <div class="statsTiles">
              <div class="tile">
                <div class="t">Poids</div>
                <div class="v" id="tileWeight">‚Äî</div>
                <div class="s" id="tileWeightSub">‚Äî</div>
              </div>
              <div class="tile">
                <div class="t">Moyenne 7j</div>
                <div class="v" id="tileAvg7">‚Äî</div>
                <div class="s" id="tileTrend">‚Äî</div>
              </div>
              <div class="tile">
                <div class="t">Perte totale</div>
                <div class="v" id="tileLost">‚Äî</div>
                <div class="s" id="tileETA">‚Äî</div>
              </div>
              <div class="tile">
                <div class="t">Aujourd‚Äôhui</div>
                <div class="v" id="tileToday">‚Äî</div>
                <div class="s" id="tileMealsMove">‚Äî</div>
              </div>
            </div>

            <div class="quickLog">
              <div class="logCard">
                <div class="logTop">
                  <div class="name">üíß Eau</div>
                  <div class="val"><span id="waterNow">‚Äî</span> / <span id="waterGoal">‚Äî</span> ml</div>
                </div>
                <div class="bar"><div id="waterBar"></div></div>
                <div class="logBtns">
                  <button class="secondary" id="waterMinus" type="button">-250</button>
                  <button class="secondary" id="waterPlus" type="button">+250</button>
                </div>
              </div>

              <div class="logCard">
                <div class="logTop">
                  <div class="name">üò¥ Sommeil</div>
                  <div class="val"><span id="sleepNow">‚Äî</span> / <span id="sleepGoal">‚Äî</span> h</div>
                </div>
                <div class="bar"><div id="sleepBar"></div></div>
                <div class="miniInput">
                  <input id="sleepInput" type="number" step="0.5" min="0" max="16" placeholder="7.5" />
                  <button class="secondary" id="sleepSave" type="button">OK</button>
                </div>
              </div>

              <div class="logCard">
                <div class="logTop">
                  <div class="name">üçΩÔ∏è Faim</div>
                  <div class="val"><span id="hungerNow">‚Äî</span>/5</div>
                </div>
                <div class="miniInput">
                  <input id="hungerRange" type="range" min="1" max="5" step="1" />
                </div>
                <div class="tiny">1 = facile ‚Ä¢ 5 = tr√®s dur (utile pour ajuster repas)</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="cardTitle">Pes√©e & courbe</h2>
        <div class="grid2" style="margin-top:12px">
          <div>
            <label>Date</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label>Poids du jour (kg)</label>
            <input id="weight" type="number" step="0.1" inputmode="decimal" placeholder="ex : 114.6" />
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <button id="saveWeightBtn" class="primary" type="button">Ajouter</button>
          <button id="skipWeighBtn" class="secondary" type="button">Aujourd‚Äôhui je skip (OK)</button>
        </div>

        <div class="seg" id="rangeSeg">
          <button class="active" data-range="7" type="button">7j</button>
          <button data-range="30" type="button">30j</button>
          <button data-range="180" type="button">6m</button>
          <button data-range="all" type="button">Tout</button>
        </div>

        <canvas id="chart" width="1000" height="360"></canvas>
      </div>

      <div class="card">
        <h2 class="cardTitle">Repas d‚Äôaujourd‚Äôhui</h2>
        <div class="tiny" style="margin-top:8px">2 repas coch√©s = journ√©e gagn√©e.</div>
        <div class="mealGrid" id="todayMeals"></div>
      </div>
    </section>

    <!-- ===== Repas ===== -->
    <section class="section" id="secMeals">
      <div class="card">
        <h2 class="cardTitle">Repas</h2>
        <div class="coachBubble" style="margin-top:12px;background:radial-gradient(520px 220px at 15% 30%, rgba(48,209,88,.14), rgba(255,255,255,.04));border-color:rgba(48,209,88,.18)">
          <div class="coachMsg" id="foodCoach">
            R√®gle coach (sans sport) : <b>prot√©ines + l√©gumes/soupe</b> = faim contr√¥l√©e.<br>
            Si faim : <b>skyr / ≈ìufs / thon</b> avant tout sucr√©.
          </div>
        </div>

        <div class="mealGrid" id="weekMeals"></div>

        <div class="grid2" style="margin-top:12px">
          <button class="secondary" id="resetChecksBtn" type="button">R√©initialiser les coches</button>
          <button class="secondary" id="markMealsDoneBtn" type="button">Aujourd‚Äôhui : repas valid√©s</button>
        </div>
      </div>
    </section>

    <!-- ===== Activit√© ===== -->
    <section class="section" id="secActivity">
      <div class="card">
        <h2 class="cardTitle">Activit√©</h2>
        <div class="tiny" style="margin-top:8px">M√™me 10 minutes = victoire.</div>

        <div class="grid2" style="margin-top:12px">
          <div><label>Statut</label><input id="walkStatus" type="text" value="Pr√™t" readonly /></div>
          <div><label>Temps</label><input id="walkTime" type="text" value="00:00:00" readonly /></div>
          <div><label>Distance</label><input id="walkDistance" type="text" value="0.00 km" readonly /></div>
          <div><label>Vitesse moy.</label><input id="walkSpeed" type="text" value="0.0 km/h" readonly /></div>
        </div>

        <div class="grid2" style="margin-top:12px">
          <button id="walkStartBtn" class="primary" type="button">D√©marrer</button>
          <button id="walkStopBtn" class="secondary" type="button" disabled>Terminer</button>
        </div>
        <div style="margin-top:10px">
          <button id="walkClearBtn" class="secondary" type="button">Effacer la trace</button>
        </div>
      </div>

      <div class="card">
        <h2 class="cardTitle">Carte</h2>
        <div id="walkMap" style="margin-top:12px"></div>
        <div class="tiny" style="margin-top:10px">
          (Si hors ligne, la marche continue mais la carte peut √™tre vide.)
        </div>
      </div>

      <div class="card">
        <h2 class="cardTitle">Historique</h2>
        <div class="mealGrid" id="walkHistory"></div>
        <div class="grid2" style="margin-top:12px">
          <button class="secondary" id="walkExportBtn" type="button">Exporter (JSON)</button>
          <button class="secondary" id="walkClearAllBtn" type="button">Tout effacer</button>
        </div>
      </div>
    </section>

    <!-- ===== Profil ===== -->
    <section class="section" id="secProfile">
      <div class="card">
        <h2 class="cardTitle">Profil & objectifs</h2>
        <div class="tiny" style="margin-top:8px">
          Ici tu r√®gles ton ‚Äúcoach‚Äù. Plus les objectifs sont simples, plus tu tiens.
        </div>

        <div class="grid2" style="margin-top:12px">
          <div><label>Taille (cm)</label><input id="height" type="number" step="1" inputmode="numeric" placeholder="173" /></div>
          <div><label>Poids de d√©part (kg)</label><input id="startWeight" type="number" step="0.1" inputmode="decimal" placeholder="115" /></div>
          <div><label>Objectif (kg)</label><input id="targetWeight" type="number" step="0.1" inputmode="decimal" placeholder="85" /></div>
          <div><label>Marche / jour (min)</label><input id="moveGoalMin" type="number" step="5" inputmode="numeric" placeholder="30" /></div>
        </div>

        <div class="grid2" style="margin-top:12px">
          <div><label>Eau / jour (ml)</label><input id="waterGoalMl" type="number" step="250" inputmode="numeric" placeholder="2000" /></div>
          <div><label>Sommeil cible (heures)</label><input id="sleepGoalH" type="number" step="0.5" inputmode="decimal" placeholder="7.5" /></div>
        </div>

        <div class="grid2" style="margin-top:12px">
          <div>
            <label>Pes√©e</label>
            <select id="weighMode">
              <option value="daily" selected>Quotidienne (pr√©cis)</option>
              <option value="3x">3√ó/semaine (moins stress)</option>
            </select>
          </div>
          <div>
            <label>Ton du coach</label>
            <select id="coachTone">
              <option value="soft" selected>Doux (anti-culpabilit√©)</option>
              <option value="balanced">√âquilibr√©</option>
              <option value="strict">Direct (plus ferme)</option>
            </select>
          </div>
        </div>

        <div class="grid2" style="margin-top:12px">
          <div>
            <label>Jours conseill√©s (si 3√ó/sem)</label>
            <select id="weighDays">
              <option value="LMV" selected>Lun / Mer / Ven</option>
              <option value="MJS">Mar / Jeu / Sam</option>
              <option value="LMJ">Lun / Mer / Jeu</option>
            </select>
          </div>
          <div>
            <label>Œ©-3 / semaine</label>
            <select id="omegaTarget">
              <option value="2">2 fois</option>
              <option value="3" selected>3 fois</option>
              <option value="4">4 fois</option>
            </select>
          </div>
        </div>

        <div class="grid2" style="margin-top:12px">
          <button id="saveProfileBtn" class="primary" type="button">Enregistrer</button>
          <button class="secondary" id="exportBackupBtn" type="button">Backup (JSON)</button>
        </div>
        <div class="grid2" style="margin-top:10px">
          <button class="secondary" id="importBackupBtn" type="button">Importer (JSON)</button>
          <button class="secondary" id="clearAllBtn" type="button">Tout effacer</button>
        </div>

        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>

      <div class="card">
        <h2 class="cardTitle">Stats perso (coach)</h2>
        <div class="tiny" style="margin-top:8px">On suit la constance, pas la perfection.</div>

        <div class="statsTiles" style="margin-top:12px">
          <div class="tile"><div class="t">Jours suivis</div><div class="v" id="pDays">‚Äî</div><div class="s">jours avec au moins 1 action</div></div>
          <div class="tile"><div class="t">Taux 7 jours</div><div class="v" id="pRate7">‚Äî</div><div class="s">missions valid√©es / possibles</div></div>
          <div class="tile"><div class="t">Meilleure semaine</div><div class="v" id="pBest7">‚Äî</div><div class="s">meilleur score sur 7 jours</div></div>
          <div class="tile"><div class="t">IMC (si poids)</div><div class="v" id="pBMI">‚Äî</div><div class="s" id="pBMILabel">‚Äî</div></div>
        </div>
      </div>
    </section>

  </div>
</div>

<nav class="bottomNav" aria-label="Navigation">
  <div class="navGrid">
    <button class="navBtn active" id="navSummary" type="button"><span class="ico">üè†</span><span>R√©sum√©</span></button>
    <button class="navBtn" id="navMeals" type="button"><span class="ico">üç≤</span><span>Repas</span></button>
    <button class="navBtn" id="navActivity" type="button"><span class="ico">üö∂‚Äç‚ôÇÔ∏è</span><span>Activit√©</span></button>
    <button class="navBtn" id="navProfile" type="button"><span class="ico">üë§</span><span>Profil</span></button>
  </div>
</nav>

<script>
document.addEventListener("DOMContentLoaded", () => {
  "use strict";
  window.addEventListener("error", (e) => alert("Erreur dans le script :\n" + (e?.message || "inconnue")));

  // ===== Storage =====
  const STORAGE = {
    PROFILE: "coach_profile_v3",
    WEIGHTS: "coach_weights_v3",
    MEAL_CHECKS: "coach_meal_checks_v3",
    WALKS: "coach_walks_v3",
    WALK_ACTIVE: "coach_walk_active_v3",
    UI_RANGE: "coach_ui_range_v3",
    DAILY: "coach_daily_v3", // eau/sommeil/faim + missions + xp
  };

  const DEFAULT_PROFILE = {
    heightCm: 173,
    startWeight: 115.0,
    targetWeight: 85.0,
    omegaTarget: 3,
    moveGoalMin: 30,
    waterGoalMl: 2000,
    sleepGoalH: 7.5,
    weighMode: "daily",
    weighDays: "LMV",
    coachTone: "soft"
  };

  const PROTEINS = ["Poulet","≈íufs","Thon","Skyr","Sardines"];
  const WEEK_PLAN = {
    lunch:  ["Poulet","Poulet","Thon","Poulet","Poulet","Sardines","Poulet"],
    dinner: ["≈íufs","Skyr","≈íufs","Thon","Skyr","≈íufs","Sardines"]
  };
  const MEAL_DEFAULTS = { lunchSoupMl:700, dinnerSoupMl:450 };
  const GPS_OPTS = { enableHighAccuracy:true, maximumAge:1000, timeout:20000 };

  // ===== DOM helpers =====
  const $ = (id)=>document.getElementById(id);
  const exists = (id)=>!!document.getElementById(id);
  const setText = (id, txt)=>{ const el=$(id); if(el) el.textContent = txt; };
  const setHTML = (id, html)=>{ const el=$(id); if(el) el.innerHTML = html; };

  // ===== JSON helpers =====
  const loadJSON = (key, fallback)=>{ try{ const v=localStorage.getItem(key); return v?JSON.parse(v):fallback; }catch{ return fallback; } };
  const saveJSON = (key, val)=>localStorage.setItem(key, JSON.stringify(val));
  const del = (key)=>localStorage.removeItem(key);

  function downloadText(filename, text, mime){
    const blob=new Blob([text], {type:mime||"text/plain;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // ===== Toasts =====
  function toast(type, title, msg, ms=1800){
    const box=$("toasts"); if(!box) return;
    const el=document.createElement("div");
    el.className="toast " + (type||"");
    const ico = type==="good" ? "‚úÖ" : type==="bad" ? "‚õî" : "‚ú®";
    el.innerHTML = `
      <div class="ico">${ico}</div>
      <div>
        <div class="title">${title||"Info"}</div>
        <div class="msg">${msg||""}</div>
      </div>
      <button class="x" type="button">‚úï</button>
    `;
    const kill=()=>{ el.style.opacity="0"; el.style.transform="translateY(8px)"; setTimeout(()=>el.remove(), 220); };
    el.querySelector(".x").addEventListener("click", kill);
    box.appendChild(el);
    if(ms>0) setTimeout(kill, ms);
  }

  // ===== Utils =====
  const clamp=(v,min,max)=>Math.max(min, Math.min(max, v));
  const fmt=(n,d=1)=>{ if(n===null||n===undefined||n==="") return "‚Äî"; const x=Number(n); if(Number.isNaN(x)) return "‚Äî"; return x.toFixed(d); };

  function isoToday(){
    const d=new Date();
    const tz=d.getTimezoneOffset()*60000;
    return new Date(d - tz).toISOString().slice(0,10);
  }
  function addDays(iso,n){
    const d=new Date(iso+"T00:00:00");
    d.setDate(d.getDate()+n);
    const tz=d.getTimezoneOffset()*60000;
    return new Date(d - tz).toISOString().slice(0,10);
  }
  function dayName(iso){
    const d=new Date(iso+"T00:00:00");
    return ["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"][d.getDay()];
  }
  function sameIsoDay(ts, iso){
    const d=new Date(ts);
    const tz=d.getTimezoneOffset()*60000;
    const isoTs=new Date(d - tz).toISOString().slice(0,10);
    return isoTs===iso;
  }
  const pad2=n=>String(n).padStart(2,"0");
  function fmtHMS(ms){
    const s=Math.max(0, Math.floor(ms/1000));
    const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60;
    return `${pad2(h)}:${pad2(m)}:${pad2(ss)}`;
  }

  // ===== Tabs =====
  const SECTIONS = [
    ["navSummary","secSummary"],
    ["navMeals","secMeals"],
    ["navActivity","secActivity"],
    ["navProfile","secProfile"]
  ];
  function setTab(navId){
    SECTIONS.forEach(([nav, sec])=>{
      $(nav)?.classList.toggle("active", nav===navId);
      $(sec)?.classList.toggle("active", nav===navId);
    });
    window.scrollTo({top:0, behavior:"smooth"});
  }
  $("navSummary")?.addEventListener("click", ()=>setTab("navSummary"));
  $("navMeals")?.addEventListener("click", ()=>setTab("navMeals"));
  $("navActivity")?.addEventListener("click", ()=>setTab("navActivity"));
  $("navProfile")?.addEventListener("click", ()=>setTab("navProfile"));

  // ===== Profile =====
  function loadProfile(){
    let p = loadJSON(STORAGE.PROFILE, null);
    if(!p){ p = DEFAULT_PROFILE; saveJSON(STORAGE.PROFILE, p); }
    // patch
    if(typeof p.moveGoalMin!=="number") p.moveGoalMin = DEFAULT_PROFILE.moveGoalMin;
    if(typeof p.waterGoalMl!=="number") p.waterGoalMl = DEFAULT_PROFILE.waterGoalMl;
    if(typeof p.sleepGoalH!=="number") p.sleepGoalH = DEFAULT_PROFILE.sleepGoalH;
    if(!p.weighMode) p.weighMode = DEFAULT_PROFILE.weighMode;
    if(!p.weighDays) p.weighDays = DEFAULT_PROFILE.weighDays;
    if(!p.coachTone) p.coachTone = DEFAULT_PROFILE.coachTone;
    return p;
  }

  // ===== Daily store (missions + eau + sommeil + faim) =====
  function loadDaily(){ return loadJSON(STORAGE.DAILY, {}); }
  function saveDaily(obj){ saveJSON(STORAGE.DAILY, obj); }

  function ensureDay(iso){
    const all=loadDaily();
    if(!all[iso]){
      all[iso]={
        tasks:{ weigh:false, meals:false, move:false },
        xp:0,
        waterMl:0,
        sleepH:null,
        hunger:3
      };
      saveDaily(all);
    }
    return all[iso];
  }
  function setTask(iso, key, val){
    const all=loadDaily();
    if(!all[iso]) ensureDay(iso);
    all[iso].tasks[key]=!!val;
    saveDaily(all);
  }
  function addXP(amount){
    const today=isoToday();
    const all=loadDaily();
    if(!all[today]) ensureDay(today);
    all[today].xp = (all[today].xp||0) + (Number(amount)||0);
    saveDaily(all);
  }
  function totalXP(){
    const all=loadDaily();
    return Object.values(all).reduce((sum, d)=>sum + (d?.xp||0), 0);
  }
  function levelFromXP(xp){
    if(xp < 120) return { name:"D√©part", next:120 };
    if(xp < 320) return { name:"R√©gulier", next:320 };
    if(xp < 600) return { name:"Solide", next:600 };
    if(xp < 1000) return { name:"Coach√©", next:1000 };
    return { name:"Machine üòÑ", next:null };
  }
  function flexStreakWeights(rows, todayISO){
    const set=new Set(rows.filter(r=>typeof r.weight==="number").map(r=>r.date));
    let ok=0;
    for(let i=0;i<7;i++){
      const d=addDays(todayISO, -i);
      if(set.has(d)) ok++;
    }
    return ok;
  }

  function setWater(delta){
    const today=isoToday();
    const all=loadDaily();
    if(!all[today]) ensureDay(today);
    all[today].waterMl = clamp((all[today].waterMl||0) + delta, 0, 10000);
    saveDaily(all);
  }
  function setSleep(hours){
    const today=isoToday();
    const all=loadDaily();
    if(!all[today]) ensureDay(today);
    const v=Number(hours);
    all[today].sleepH = Number.isNaN(v) ? null : clamp(v, 0, 16);
    saveDaily(all);
  }
  function setHunger(v){
    const today=isoToday();
    const all=loadDaily();
    if(!all[today]) ensureDay(today);
    all[today].hunger = clamp(Number(v)||3, 1, 5);
    saveDaily(all);
  }

  // ===== Weights =====
  function loadWeights(){
    const rows = loadJSON(STORAGE.WEIGHTS, []);
    return Array.isArray(rows)
      ? rows.filter(r=>r && r.date && typeof r.date==="string").sort((a,b)=>a.date.localeCompare(b.date))
      : [];
  }
  function saveWeight(dateISO, weight){
    const rows = loadWeights();
    const idx = rows.findIndex(r=>r.date===dateISO);
    const row = { date:dateISO, weight:Number(weight) };
    if(idx>=0) rows[idx]=row; else rows.push(row);
    rows.sort((a,b)=>a.date.localeCompare(b.date));
    saveJSON(STORAGE.WEIGHTS, rows);
  }
  function computeStats(profile, rows){
    const withW = rows.filter(r=>typeof r.weight==="number");
    const current = withW.length ? withW[withW.length-1].weight : null;
    const lost = (current!=null) ? (Number(profile.startWeight) - current) : null;

    const last7 = withW.slice(-7).map(r=>r.weight);
    const avg7 = last7.length ? last7.reduce((a,b)=>a+b,0)/last7.length : null;

    const prev7 = withW.slice(-14,-7).map(r=>r.weight);
    const avgPrev7 = prev7.length ? prev7.reduce((a,b)=>a+b,0)/prev7.length : null;

    return { current, lost, avg7, avgPrev7, count: withW.length };
  }
  function computeBMI(profile, current){
    const h = Number(profile.heightCm);
    if(!h || !current) return null;
    const m = h/100;
    return current/(m*m);
  }
  function bmiLabel(bmi){
    if(bmi==null) return "‚Äî";
    if(bmi < 18.5) return "Insuffisance pond√©rale";
    if(bmi < 25) return "Corpulence normale";
    if(bmi < 30) return "Surpoids";
    if(bmi < 35) return "Ob√©sit√© (classe I)";
    if(bmi < 40) return "Ob√©sit√© (classe II)";
    return "Ob√©sit√© (classe III)";
  }
  function estimateETA(profile, stats){
    const tw = Number(profile.targetWeight);
    const cur = stats.current;
    if(cur==null || Number.isNaN(tw)) return null;
    const remaining = cur - tw;
    if(remaining <= 0) return { text:"Objectif atteint", date:null };
    if(stats.avg7==null || stats.avgPrev7==null) return { text:"Ajoute des donn√©es", date:null };
    const weeklyLoss = (stats.avgPrev7 - stats.avg7);
    if(weeklyLoss <= 0.05) return { text:"Tendance stable", date:null };
    const weeks = remaining / weeklyLoss;
    const days = Math.ceil(weeks*7);
    const eta = new Date(); eta.setDate(eta.getDate()+days);
    return { text:`‚âà ${days} jours`, date:eta };
  }

  // ===== Range / Chart =====
  function loadRange(){ return loadJSON(STORAGE.UI_RANGE, "7") || "7"; }
  function saveRange(v){ saveJSON(STORAGE.UI_RANGE, v); }
  function filterByRange(rows, range){
    const withW = rows.filter(r=>typeof r.weight==="number");
    if(range==="all") return withW;
    const days = Number(range);
    if(!days || Number.isNaN(days)) return withW;
    const end = withW.length ? new Date(withW[withW.length-1].date+"T00:00:00").getTime() : Date.now();
    const start = end - (days-1)*24*3600*1000;
    return withW.filter(r=>{
      const t = new Date(r.date+"T00:00:00").getTime();
      return t >= start && t <= end;
    });
  }
  function drawWeightChart(profile, rows, range){
    const c=$("chart"); if(!c) return;
    const ctx=c.getContext("2d");
    const W=c.width, H=c.height;
    ctx.clearRect(0,0,W,H);

    const data = filterByRange(rows, range)
      .map(r=>({x:new Date(r.date+"T00:00:00").getTime(), y:r.weight}))
      .sort((a,b)=>a.x-b.x);

    ctx.fillStyle="rgba(0,0,0,.18)";
    ctx.fillRect(0,0,W,H);
    ctx.strokeStyle="rgba(255,255,255,.10)";
    ctx.lineWidth=1;
    ctx.strokeRect(0.5,0.5,W-1,H-1);

    ctx.font="13px -apple-system, system-ui";
    ctx.fillStyle="rgba(255,255,255,.65)";
    if(data.length<2){
      ctx.fillText("Ajoute 2 pes√©es pour afficher la courbe.", 16, 28);
      return;
    }

    const padL=58, padR=16, padT=14, padB=34;
    const plotW=W-padL-padR, plotH=H-padT-padB;

    const minX=data[0].x, maxX=data[data.length-1].x;
    const ys=data.map(p=>p.y);
    let minY=Math.min(...ys), maxY=Math.max(...ys);
    const margin=Math.max(0.8,(maxY-minY)*0.22);
    minY-=margin; maxY+=margin;

    const xToPx=x=>padL+((x-minX)/(maxX-minX))*plotW;
    const yToPx=y=>padT+(1-((y-minY)/(maxY-minY)))*plotH;

    ctx.strokeStyle="rgba(255,255,255,.07)";
    ctx.fillStyle="rgba(255,255,255,.45)";
    ctx.font="12px -apple-system, system-ui";
    for(let i=0;i<=4;i++){
      const t=i/4;
      const yVal=maxY - t*(maxY-minY);
      const y=yToPx(yVal);
      ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
      ctx.fillText(yVal.toFixed(1), 12, y+4);
    }

    const tw=Number(profile.targetWeight);
    if(!Number.isNaN(tw)){
      const yT=yToPx(tw);
      ctx.setLineDash([7,7]);
      ctx.strokeStyle="rgba(255,45,85,.30)";
      ctx.beginPath(); ctx.moveTo(padL,yT); ctx.lineTo(W-padR,yT); ctx.stroke();
      ctx.setLineDash([]);
    }

    ctx.strokeStyle="rgba(255,45,85,.95)";
    ctx.lineWidth=3;
    ctx.lineJoin="round"; ctx.lineCap="round";
    ctx.beginPath();
    data.forEach((p,i)=>{
      const x=xToPx(p.x), y=yToPx(p.y);
      if(i===0) ctx.moveTo(x,y);
      else{
        const prev=data[i-1];
        const x0=xToPx(prev.x), y0=yToPx(prev.y);
        const cx=(x0+x)/2;
        ctx.quadraticCurveTo(cx,y0, x,y);
      }
    });
    ctx.stroke();

    ctx.fillStyle="rgba(255,45,85,1)";
    data.forEach(p=>{
      const x=xToPx(p.x), y=yToPx(p.y);
      ctx.beginPath(); ctx.arc(x,y,3.2,0,Math.PI*2); ctx.fill();
    });

    const last=data[data.length-1];
    ctx.fillStyle="rgba(255,255,255,.78)";
    ctx.font="12px -apple-system, system-ui";
    ctx.fillText(`Dernier: ${last.y.toFixed(1)} kg`, 16, H-12);
  }

  // ===== Meals =====
  const mealKey=(dateISO, mealType)=>dateISO + "_" + mealType;
  const loadMealChecks=()=>loadJSON(STORAGE.MEAL_CHECKS, {});
  const saveMealChecks=(obj)=>saveJSON(STORAGE.MEAL_CHECKS, obj);

  function mealCard(dateISO, mealType){
    const checks = loadMealChecks();
    const key = mealKey(dateISO, mealType);
    const done = !!checks[key];

    const weekday = new Date(dateISO+"T00:00:00").getDay();
    const protein = mealType==="lunch" ? WEEK_PLAN.lunch[weekday] : WEEK_PLAN.dinner[weekday];
    const title = mealType==="lunch" ? "Midi" : "Soir";
    const soupMl = mealType==="lunch" ? MEAL_DEFAULTS.lunchSoupMl : MEAL_DEFAULTS.dinnerSoupMl;

    const el=document.createElement("div");
    el.className="mealCard";
    el.innerHTML = `
      <div class="mealHead">
        <div>
          <div class="mealTitle">${title}</div>
          <div class="dayLabel">${dayName(dateISO)} ‚Ä¢ ${dateISO}</div>
        </div>
        <label class="check"><input type="checkbox" ${done?"checked":""}/> fait</label>
      </div>

      <div class="item">
        <div class="left">
          <div class="icon">ü•£</div>
          <div style="min-width:0">
            <div style="font-weight:900">Soupe / l√©gumes</div>
            <div class="muted">${soupMl} ml (volume = sati√©t√©)</div>
          </div>
        </div>
      </div>

      <div class="item">
        <div class="left">
          <div class="icon">üçó</div>
          <div style="min-width:0">
            <div style="font-weight:900">Prot√©ines</div>
            <div class="muted">${mealType==="lunch" ? "‚âà 200 g" : "portion l√©g√®re"}</div>
          </div>
        </div>
        <div class="selectWrap">
          <select aria-label="Prot√©ines">
            ${PROTEINS.map(p=>`<option value="${p}" ${p===protein?"selected":""}>${p}</option>`).join("")}
          </select>
        </div>
      </div>
    `;

    const cb = el.querySelector('input[type="checkbox"]');
    cb.addEventListener("change", ()=>{
      const st=loadMealChecks();
      st[key]=cb.checked;
      saveMealChecks(st);
      if(cb.checked) addXP(8);
      toast("good","Repas", cb.checked ? "Valid√© ‚úÖ" : "Annul√©", 1200);
      render();
    });

    return el;
  }

  function mealsDoneCount(todayISO){
    const st=loadMealChecks();
    const a=!!st[mealKey(todayISO,"lunch")];
    const b=!!st[mealKey(todayISO,"dinner")];
    return (a?1:0)+(b?1:0);
  }

  // ===== Walk =====
  let watchId=null, timerId=null;
  let walkMap=null, walkLine=null, walkMarker=null;

  const getActiveWalk=()=>loadJSON(STORAGE.WALK_ACTIVE, null);
  const setActiveWalk=(w)=>{ if(!w) del(STORAGE.WALK_ACTIVE); else saveJSON(STORAGE.WALK_ACTIVE, w); };
  const loadWalks=()=>{ const rows=loadJSON(STORAGE.WALKS, []); return Array.isArray(rows)?rows:[]; };
  const saveWalks=(rows)=>saveJSON(STORAGE.WALKS, rows);

  function haversineMeters(a,b){
    const R=6371000; const toRad=x=>x*Math.PI/180;
    const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lng-a.lng);
    const lat1=toRad(a.lat), lat2=toRad(b.lat);
    const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2);
    const h=s1*s1 + Math.cos(lat1)*Math.cos(lat2)*s2*s2;
    return 2*R*Math.asin(Math.min(1, Math.sqrt(h)));
  }
  function stopWatchAndTimer(){
    if(watchId!=null){ try{ navigator.geolocation.clearWatch(watchId);}catch{} watchId=null; }
    if(timerId!=null){ clearInterval(timerId); timerId=null; }
  }
  function ensureLeafletMap(){
    const box=$("walkMap"); if(!box) return;
    if(typeof L==="undefined") return;
    if(walkMap) return;
    walkMap=L.map(box,{zoomControl:true});
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(walkMap);
    walkLine=L.polyline([], {weight:5}).addTo(walkMap);
  }
  function renderWalkOnMap(points, fit=true){
    ensureLeafletMap();
    if(!walkMap || typeof L==="undefined") return;
    if(!points?.length) return;

    const latlngs=points.map(p=>[p.lat,p.lng]);
    walkLine.setLatLngs(latlngs);

    const last=points[points.length-1];
    if(!walkMarker) walkMarker=L.circleMarker([last.lat,last.lng], {radius:6, weight:2}).addTo(walkMap);
    walkMarker.setLatLng([last.lat,last.lng]);

    if(fit){
      try{ walkMap.fitBounds(L.latLngBounds(latlngs), {padding:[20,20]}); }catch{}
    }
  }
  function renderWalkStats(w){
    if(!exists("walkStatus")) return;
    const now=Date.now();
    const elapsed = w?.active ? (now - w.startedAt) : (w?.elapsedMs || 0);
    const distM = w?.distanceM || 0;

    $("walkStatus").value = w?.active ? "En cours" : "Pr√™t";
    $("walkTime").value = fmtHMS(elapsed);
    $("walkDistance").value = (distM/1000).toFixed(2) + " km";

    const hours = elapsed/3600000;
    const km = distM/1000;
    const speed = hours>0 ? (km/hours) : 0;
    $("walkSpeed").value = speed.toFixed(1) + " km/h";

    $("walkStartBtn").disabled = !!w?.active;
    $("walkStopBtn").disabled  = !w?.active;
  }
  function renderWalkHistory(){
    const box=$("walkHistory"); if(!box) return;
    const walks=loadWalks();
    if(!walks.length){ box.innerHTML = `<div class="tiny">Aucune marche enregistr√©e.</div>`; return; }

    box.innerHTML="";
    walks.slice(0,20).forEach(w=>{
      const date=new Date(w.startedAt || Date.now());
      const d=date.toLocaleDateString("fr-FR",{weekday:"short",year:"numeric",month:"short",day:"numeric"});
      const t=date.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});
      const km=((w.distanceM||0)/1000);
      const h=((w.elapsedMs||0)/3600000);
      const v=(h>0)?(km/h):0;

      const el=document.createElement("div");
      el.className="histCard";
      el.innerHTML=`
        <div class="histTop">
          <div>
            <div class="histTitle">Marche ‚Ä¢ ${d}</div>
            <div class="histMeta">
              D√©but : ${t}<br>
              Dur√©e : ${fmtHMS(w.elapsedMs||0)} ‚Ä¢ Distance : ${km.toFixed(2)} km ‚Ä¢ Vitesse : ${v.toFixed(1)} km/h
            </div>
          </div>
          <div class="tiny">${(w.points?.length||0)} pts</div>
        </div>
        <div class="histBtns">
          <button class="secondary" type="button" data-view="${w.id}">Voir</button>
          <button class="secondary" type="button" data-del="${w.id}">Supprimer</button>
        </div>
      `;
      box.appendChild(el);
    });

    box.querySelectorAll("[data-view]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id=btn.getAttribute("data-view");
        const w=loadWalks().find(x=>x.id===id);
        if(!w?.points?.length){ toast("bad","Carte","Aucun point GPS.", 2200); return; }
        setTab("navActivity");
        setTimeout(()=>renderWalkOnMap(w.points,true), 80);
        toast("good","Carte","Trace charg√©e ‚úÖ", 1200);
      });
    });
    box.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id=btn.getAttribute("data-del");
        if(!confirm("Supprimer cette marche ?")) return;
        saveWalks(loadWalks().filter(w=>w.id!==id));
        toast("good","Marche","Supprim√©e.", 1200);
        render();
        renderWalkUI();
      });
    });
  }
  function renderWalkUI(skipFit=false){
    const cur=getActiveWalk();
    renderWalkStats(cur || {active:false, elapsedMs:0, distanceM:0});
    if(cur?.points?.length) renderWalkOnMap(cur.points, !skipFit);
    renderWalkHistory();
  }

  function beginWatch(){
    if(!navigator.geolocation){ toast("bad","GPS","G√©olocalisation indisponible.", 2400); return; }
    if(watchId!=null) return;

    watchId=navigator.geolocation.watchPosition((pos)=>{
      const cur=getActiveWalk();
      if(!cur?.active) return;

      const p={ t:Date.now(), lat:pos.coords.latitude, lng:pos.coords.longitude, acc:pos.coords.accuracy };

      if(typeof p.acc==="number" && p.acc>65){
        if(cur.points.length>0) return;
      }

      const last=cur.points[cur.points.length-1];
      if(last){
        const d=haversineMeters({lat:last.lat,lng:last.lng},{lat:p.lat,lng:p.lng});
        if(d>180) return;
        if(d<1.2) return;
        cur.distanceM += d;
      }
      cur.points.push(p);
      setActiveWalk(cur);
      renderWalkUI(true);
      render();
    }, (err)=>{
      let msg="Erreur GPS.";
      if(err?.code===1) msg="Permission refus√©e : autorise Position dans Safari.";
      if(err?.code===2) msg="Position indisponible (essaie dehors).";
      if(err?.code===3) msg="Timeout GPS (r√©essaie).";
      toast("bad","GPS",msg, 2600);
      renderWalkUI();
    }, GPS_OPTS);
  }
  function ensureTimer(){
    if(timerId!=null) return;
    timerId=setInterval(()=>{
      const cur=getActiveWalk();
      if(cur?.active){
        renderWalkUI(true);
        render();
      }
    }, 1000);
  }
  function startWalk(){
    if(!navigator.geolocation){ toast("bad","GPS","G√©olocalisation indisponible.", 2400); return; }
    const cur=getActiveWalk();
    if(cur?.active){ toast("bad","Marche","Une marche est d√©j√† en cours.", 2200); return; }

    const w={ id:"walk_"+Date.now(), active:true, startedAt:Date.now(), elapsedMs:0, distanceM:0, points:[] };
    setActiveWalk(w);
    renderWalkUI();
    toast("good","Marche","D√©marr√©e.", 1400);
    addXP(10);
    beginWatch(); ensureTimer();
  }
  function stopWalk(){
    const cur=getActiveWalk();
    if(!cur?.active){ toast("bad","Marche","Aucune marche en cours.", 2200); return; }

    cur.active=false;
    cur.endedAt=Date.now();
    cur.elapsedMs=cur.endedAt-cur.startedAt;

    const walks=loadWalks();
    walks.unshift(cur);
    saveWalks(walks);

    setActiveWalk(null);
    stopWatchAndTimer();
    renderWalkUI();
    addXP(15);
    toast("good","Marche","Enregistr√©e ‚úÖ", 1600);
    render();
  }
  function clearActiveTrace(){
    const cur=getActiveWalk();
    if(cur?.active){
      if(!confirm("Effacer la trace de la marche en cours ?")) return;
      cur.points=[]; cur.distanceM=0;
      setActiveWalk(cur);
      toast("info","Trace","Effac√©e.", 1200);
      renderWalkUI();
      render();
      return;
    }
    if(!confirm("Effacer la trace affich√©e sur la carte (sans toucher √† l‚Äôhistorique) ?")) return;
    if(walkLine) walkLine.setLatLngs([]);
    if(walkMarker && walkMap){ try{ walkMap.removeLayer(walkMarker);}catch{} walkMarker=null; }
    toast("info","Carte","Trace retir√©e.", 1200);
  }
  function exportWalks(){
    const payload={ version:1, exportedAt:new Date().toISOString(), walks:loadWalks() };
    downloadText("coach_marches.json", JSON.stringify(payload,null,2), "application/json;charset=utf-8");
    toast("good","Export","OK.", 1200);
  }
  function clearAllWalks(){
    if(!confirm("Tout effacer : historique des marches ?")) return;
    del(STORAGE.WALKS);
    setActiveWalk(null);
    stopWatchAndTimer();
    renderWalkUI();
    render();
    toast("info","Marche","Historique effac√©.", 1400);
  }

  // ===== Today calculations =====
  function computeMoveMinutesToday(todayISO){
    const walks=loadWalks();
    let min=0;
    walks.forEach(w=>{
      if(w?.startedAt && sameIsoDay(w.startedAt, todayISO)) min += (w.elapsedMs||0)/60000;
    });
    const active=getActiveWalk();
    if(active?.active && active?.startedAt && sameIsoDay(active.startedAt, todayISO)){
      min += (Date.now()-active.startedAt)/60000;
    }
    return min;
  }

  // ===== Coach (score + message) =====
  function dailyScore(profile, rows, todayISO){
    const day=ensureDay(todayISO);
    const weightsToday = rows.find(r=>r.date===todayISO && typeof r.weight==="number");
    const meals = mealsDoneCount(todayISO);
    const moveMin = computeMoveMinutesToday(todayISO);

    const weighDone = day.tasks.weigh || !!weightsToday;
    const mealsDone = day.tasks.meals || (meals>=2);
    const moveDone  = day.tasks.move  || (moveMin>=10);

    let score=0;
    if(weighDone) score++;
    if(mealsDone) score++;
    if(moveDone) score++;

    return { score, max:3, weighDone, mealsDone, moveDone, meals, moveMin };
  }

  function coachText(profile, stats, score){
    const tone = profile.coachTone || "soft";
    const soft = (s)=>s;
    const strict = (s)=>s.replaceAll("peux", "dois").replaceAll("OK", "On le fait.");

    const base = (()=> {
      if(stats.current==null){
        return "Plan simple : coche 2 repas + marche 10 minutes. Tu n‚Äôas pas besoin d‚Äô√™tre sportif : juste constant.";
      }
      if(score.score===3) return "Journ√©e gagn√©e ‚úÖ Tu peux t‚Äôarr√™ter l√† : maintien + hydratation + sommeil.";
      if(score.score===2) return "Tr√®s bien. Il manque juste 1 mini-action pour gagner la journ√©e.";
      if(score.score===1) return "On avance. Choisis l‚Äôaction la plus facile maintenant (m√™me 10 min).";
      return "Aujourd‚Äôhui : 2 repas simples + 10 minutes. Simple = durable.";
    })();

    if(tone==="strict") return strict(base);
    return soft(base);
  }

  // ===== Missions UI =====
  function renderMissions(profile, stats, todayISO){
    const rows=loadWeights();
    const score = dailyScore(profile, rows, todayISO);

    setText("dailyScore", `Score : ${score.score}/${score.max} (objectif = 2/3)`);
    setText("todayBadge", `üéØ Marche: ${Math.round(score.moveMin)} / ${Number(profile.moveGoalMin)||30} min`);
    setText("coachMsg", coachText(profile, stats, score));

    const box=$("missions");
    if(!box) return;
    box.innerHTML="";

    const items = [
      { key:"weigh", ico:"‚öñÔ∏è", name:"Pes√©e (ou skip OK)", hint:"La tendance compte plus qu‚Äôun jour.", xp:"+12 XP", checked:score.weighDone },
      { key:"meals", ico:"üç≤", name:"2 repas simples", hint:"Prot√©ines + l√©gumes/soupe = sati√©t√©.", xp:"+16 XP", checked:score.mealsDone },
      { key:"move",  ico:"üö∂‚Äç‚ôÇÔ∏è", name:"Marche 10 min", hint:"10 min = victoire. Pas besoin de sport.", xp:"+14 XP", checked:score.moveDone },
    ];

    items.forEach(it=>{
      const row=document.createElement("div");
      row.className="task";
      row.innerHTML=`
        <div class="taskLeft">
          <div class="taskIco">${it.ico}</div>
          <div style="min-width:0">
            <div class="taskName">${it.name}</div>
            <div class="taskHint">${it.hint}</div>
          </div>
        </div>
        <div class="taskRight">
          <div class="xpTag">${it.xp}</div>
          <input type="checkbox" ${it.checked?"checked":""} aria-label="${it.name}">
        </div>
      `;
      const cb=row.querySelector("input");
      cb.addEventListener("change", ()=>{
        setTask(todayISO, it.key, cb.checked);
        if(cb.checked){
          addXP(it.key==="weigh"?12:it.key==="meals"?16:14);
          toast("good","Mission","Valid√©e ‚úÖ", 1200);
        }else{
          toast("info","Mission","Retir√©e", 1000);
        }
        render();
      });
      box.appendChild(row);
    });
  }

  // ===== Summary tiles + daily log =====
  function renderSnapshot(profile, stats, todayISO){
    const rows=loadWeights();
    const day=ensureDay(todayISO);
    const meals = mealsDoneCount(todayISO);
    const moveMin = computeMoveMinutesToday(todayISO);
    const score = dailyScore(profile, rows, todayISO);

    // Tiles values
    setText("tileWeight", stats.current!=null ? `${fmt(stats.current,1)} kg` : "‚Äî");
    setText("tileWeightSub", stats.current!=null ? `Derni√®re pes√©e: ${rows.filter(r=>typeof r.weight==="number").slice(-1)[0]?.date || "‚Äî"}` : "Ajoute une pes√©e");

    setText("tileAvg7", stats.avg7!=null ? `${fmt(stats.avg7,1)} kg` : "‚Äî");

    const trend=(stats.avgPrev7!=null && stats.avg7!=null) ? (stats.avgPrev7 - stats.avg7) : null;
    if(trend==null) setText("tileTrend","Tendance: ‚Äî");
    else{
      const dir = trend>0.05 ? "‚¨áÔ∏é" : trend<-0.05 ? "‚¨ÜÔ∏é" : "‚Üí";
      const lbl = trend>0 ? `baisse ${trend.toFixed(1)} kg/sem` : `hausse ${Math.abs(trend).toFixed(1)} kg/sem`;
      setText("tileTrend", `Tendance: ${dir} ${lbl}`);
    }

    const lost = stats.lost;
    setHTML("tileLost", lost!=null ? `<span class="${lost>=0?'pos':'neg'}">${fmt(lost,1)} kg</span>` : "‚Äî");
    const eta=estimateETA(profile, stats);
    if(!eta) setText("tileETA","Estimation: ‚Äî");
    else{
      if(eta.date){
        const d=eta.date.toLocaleDateString("fr-FR",{year:"numeric",month:"short",day:"numeric"});
        setText("tileETA", `Est.: ${eta.text} ‚Ä¢ ${d}`);
      }else setText("tileETA", `Est.: ${eta.text}`);
    }

    setText("tileToday", `${score.score}/3`);
    setText("tileMealsMove", `Repas: ${meals}/2 ‚Ä¢ Marche: ${Math.round(moveMin)} min`);

    // Header
    setText("headerWeight", stats.current!=null ? `${fmt(stats.current,1)} kg` : "‚Äî");
    setText("badgeStreak", `${flexStreakWeights(rows, todayISO)}/7`);

    const xp=totalXP();
    setText("badgeXP", String(xp));
    setText("badgeLevel", levelFromXP(xp).name);

    // Daily log bars
    setText("waterNow", String(day.waterMl||0));
    setText("waterGoal", String(profile.waterGoalMl||DEFAULT_PROFILE.waterGoalMl));
    const wPct = clamp(((day.waterMl||0) / (profile.waterGoalMl||DEFAULT_PROFILE.waterGoalMl)) * 100, 0, 100);
    if($("waterBar")) $("waterBar").style.width = wPct.toFixed(0) + "%";

    setText("sleepNow", day.sleepH==null ? "‚Äî" : String(day.sleepH));
    setText("sleepGoal", String(profile.sleepGoalH||DEFAULT_PROFILE.sleepGoalH));
    const sPct = day.sleepH==null ? 0 : clamp((day.sleepH / (profile.sleepGoalH||DEFAULT_PROFILE.sleepGoalH)) * 100, 0, 100);
    if($("sleepBar")) $("sleepBar").style.width = sPct.toFixed(0) + "%";

    setText("hungerNow", String(day.hunger||3));
    if($("hungerRange")) $("hungerRange").value = String(day.hunger||3);
  }

  // ===== Profile stats =====
  function profileStats(profile, stats){
    const today=isoToday();
    const all=loadDaily();
    const days = Object.keys(all);

    // jours avec action
    const daysTracked = days.filter(k=>{
      const d=all[k];
      const anyTask = d?.tasks && (d.tasks.weigh || d.tasks.meals || d.tasks.move);
      const anyLog = (d?.waterMl||0)>0 || d?.sleepH!=null || d?.hunger!=null;
      return !!(anyTask || anyLog);
    }).length;

    // taux sur 7 jours (missions)
    let done=0, possible=0;
    for(let i=0;i<7;i++){
      const iso=addDays(today, -i);
      const d=all[iso];
      if(!d) continue;
      possible += 3;
      if(d.tasks?.weigh) done++;
      if(d.tasks?.meals) done++;
      if(d.tasks?.move) done++;
    }
    const rate7 = possible ? Math.round((done/possible)*100) : 0;

    // meilleure semaine (glissante)
    let best = 0;
    for(let start=0; start<30; start++){
      let dsum=0, psum=0;
      for(let i=0;i<7;i++){
        const iso=addDays(today, -(start+i));
        const d=all[iso];
        psum += 3;
        if(d?.tasks?.weigh) dsum++;
        if(d?.tasks?.meals) dsum++;
        if(d?.tasks?.move) dsum++;
      }
      best = Math.max(best, psum ? Math.round((dsum/psum)*100) : 0);
    }

    // BMI
    const bmi = computeBMI(profile, stats.current);
    setText("pDays", String(daysTracked));
    setText("pRate7", (possible?`${rate7}%`:"‚Äî"));
    setText("pBest7", (days.length?`${best}%`:"‚Äî"));
    setText("pBMI", bmi!=null ? bmi.toFixed(1) : "‚Äî");
    setText("pBMILabel", bmi!=null ? bmiLabel(bmi) : "Ajoute une pes√©e");
  }

  // ===== Main render =====
  function render(){
    const profile=loadProfile();
    const rows=loadWeights();
    const stats=computeStats(profile, rows);
    const todayISO=isoToday();
    const selectedISO = $("date")?.value || todayISO;

    // init date
    if(exists("date") && !$("date").value) $("date").value=todayISO;

    // autofill weight
    const existing = rows.find(r=>r.date===selectedISO);
    if(existing && exists("weight")){
      if($("weight").value==="" || $("weight").dataset.autofill==="1"){
        $("weight").value = existing.weight;
        $("weight").dataset.autofill="1";
      }
    }

    // profile fields
    if(exists("height")) $("height").value = profile.heightCm ?? "";
    if(exists("startWeight")) $("startWeight").value = profile.startWeight ?? "";
    if(exists("targetWeight")) $("targetWeight").value = profile.targetWeight ?? "";
    if(exists("omegaTarget")) $("omegaTarget").value = String(profile.omegaTarget ?? 3);
    if(exists("moveGoalMin")) $("moveGoalMin").value = String(profile.moveGoalMin ?? DEFAULT_PROFILE.moveGoalMin);
    if(exists("waterGoalMl")) $("waterGoalMl").value = String(profile.waterGoalMl ?? DEFAULT_PROFILE.waterGoalMl);
    if(exists("sleepGoalH")) $("sleepGoalH").value = String(profile.sleepGoalH ?? DEFAULT_PROFILE.sleepGoalH);
    if(exists("weighMode")) $("weighMode").value = profile.weighMode ?? "daily";
    if(exists("weighDays")) $("weighDays").value = profile.weighDays ?? "LMV";
    if(exists("coachTone")) $("coachTone").value = profile.coachTone ?? "soft";

    // subtitle rotating
    const libs=[
      "Objectif : gagner ta journ√©e (2/3).",
      "Sans sport : sati√©t√© + r√©gularit√© = perte de poids.",
      "Un jour imparfait n‚Äôannule pas la semaine.",
      "Petite action maintenant ‚Üí gros r√©sultat plus tard."
    ];
    const idx=Math.floor(Date.now()/(10*60*1000)) % libs.length;
    setText("headerSubtitle", libs[idx]);

    // chart
    drawWeightChart(profile, rows, loadRange());

    // meals today + week
    if(exists("todayMeals")){
      $("todayMeals").innerHTML="";
      $("todayMeals").appendChild(mealCard(selectedISO,"lunch"));
      $("todayMeals").appendChild(mealCard(selectedISO,"dinner"));
    }
    if(exists("weekMeals")){
      $("weekMeals").innerHTML="";
      for(let i=0;i<7;i++){
        const d=addDays(todayISO, i);
        $("weekMeals").appendChild(mealCard(d,"lunch"));
        $("weekMeals").appendChild(mealCard(d,"dinner"));
      }
    }

    // snapshot + missions + profile stats
    renderSnapshot(profile, stats, todayISO);
    renderMissions(profile, stats, todayISO);
    profileStats(profile, stats);

    // walk UI
    renderWalkUI();
  }

  // ===== Events =====
  $("date")?.addEventListener("change", ()=>{
    if(exists("weight")){
      $("weight").dataset.autofill="1";
      $("weight").value="";
    }
    render();
  });

  $("saveWeightBtn")?.addEventListener("click", ()=>{
    const d=$("date")?.value;
    const w=$("weight")?.value ? Number($("weight").value) : null;
    if(!d){ toast("bad","Date","Choisis une date.", 2200); return; }
    if(w===null || Number.isNaN(w)){ toast("bad","Poids","Entre ton poids.", 2200); return; }

    saveWeight(d,w);
    if(exists("weight")) $("weight").dataset.autofill="0";

    if(d===isoToday()){
      setTask(d,"weigh",true);
      addXP(12);
    }
    toast("good","Poids","Enregistr√© ‚úÖ", 1400);
    render();
  });

  $("skipWeighBtn")?.addEventListener("click", ()=>{
    const today=isoToday();
    setTask(today,"weigh",true);
    addXP(4);
    toast("good","Pes√©e","OK. On garde la r√©gularit√© sans stress.", 1600);
    render();
  });

  // Range segmented
  const rangeSeg=$("rangeSeg");
  rangeSeg?.querySelectorAll("[data-range]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const v=btn.getAttribute("data-range");
      saveRange(v);
      rangeSeg.querySelectorAll("button").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      render();
    });
  });

  // Meals tools
  $("resetChecksBtn")?.addEventListener("click", ()=>{
    if(!confirm("R√©initialiser toutes les coches repas ?")) return;
    del(STORAGE.MEAL_CHECKS);
    toast("info","Repas","Coches r√©initialis√©es.", 1400);
    render();
  });
  $("markMealsDoneBtn")?.addEventListener("click", ()=>{
    const today=isoToday();
    setTask(today,"meals",true);
    addXP(10);
    toast("good","Repas","Aujourd‚Äôhui valid√© ‚úÖ", 1400);
    render();
  });

  // Water / sleep / hunger
  $("waterPlus")?.addEventListener("click", ()=>{ setWater(+250); addXP(1); render(); });
  $("waterMinus")?.addEventListener("click", ()=>{ setWater(-250); render(); });

  $("sleepSave")?.addEventListener("click", ()=>{
    const v=$("sleepInput")?.value;
    setSleep(v);
    addXP(2);
    toast("good","Sommeil","Not√©.", 1200);
    render();
  });

  $("hungerRange")?.addEventListener("input", (e)=>{
    setHunger(e.target.value);
    render();
  });

  // Walk wiring
  $("walkStartBtn")?.addEventListener("click", startWalk);
  $("walkStopBtn")?.addEventListener("click", stopWalk);
  $("walkClearBtn")?.addEventListener("click", clearActiveTrace);
  $("walkExportBtn")?.addEventListener("click", exportWalks);
  $("walkClearAllBtn")?.addEventListener("click", clearAllWalks);

  // Profile save
  $("saveProfileBtn")?.addEventListener("click", ()=>{
    const p={
      heightCm: $("height")?.value ? Number($("height").value) : null,
      startWeight: $("startWeight")?.value ? Number($("startWeight").value) : null,
      targetWeight: $("targetWeight")?.value ? Number($("targetWeight").value) : null,
      omegaTarget: $("omegaTarget")?.value ? Number($("omegaTarget").value) : 3,
      moveGoalMin: $("moveGoalMin")?.value ? Number($("moveGoalMin").value) : DEFAULT_PROFILE.moveGoalMin,
      waterGoalMl: $("waterGoalMl")?.value ? Number($("waterGoalMl").value) : DEFAULT_PROFILE.waterGoalMl,
      sleepGoalH: $("sleepGoalH")?.value ? Number($("sleepGoalH").value) : DEFAULT_PROFILE.sleepGoalH,
      weighMode: $("weighMode")?.value || "daily",
      weighDays: $("weighDays")?.value || "LMV",
      coachTone: $("coachTone")?.value || "soft"
    };
    if(!p.startWeight || !p.targetWeight){
      toast("bad","Profil","Remplis poids de d√©part et objectif.", 2400);
      return;
    }
    if(!p.moveGoalMin || p.moveGoalMin<5) p.moveGoalMin = DEFAULT_PROFILE.moveGoalMin;
    if(!p.waterGoalMl || p.waterGoalMl<500) p.waterGoalMl = DEFAULT_PROFILE.waterGoalMl;
    if(!p.sleepGoalH || p.sleepGoalH<4) p.sleepGoalH = DEFAULT_PROFILE.sleepGoalH;

    saveJSON(STORAGE.PROFILE, p);
    addXP(8);
    toast("good","Profil","Enregistr√© ‚úÖ", 1400);
    render();
    setTab("navSummary");
  });

  // Backup
  $("exportBackupBtn")?.addEventListener("click", ()=>{
    const payload={
      version:3,
      exportedAt:new Date().toISOString(),
      profile: loadProfile(),
      weights: loadWeights(),
      mealChecks: loadMealChecks(),
      walks: loadWalks(),
      walkActive: getActiveWalk(),
      daily: loadDaily()
    };
    downloadText("coach_backup.json", JSON.stringify(payload,null,2), "application/json;charset=utf-8");
    toast("good","Backup","Export√©.", 1200);
  });

  $("importBackupBtn")?.addEventListener("click", ()=> $("importFile")?.click());
  $("importFile")?.addEventListener("change", async (e)=>{
    const f=e.target.files?.[0];
    if(!f) return;
    try{
      const text=await f.text();
      const payload=JSON.parse(text);
      if(!payload) throw new Error("Fichier invalide");
      if(!confirm("Importer ce backup et remplacer tes donn√©es ?")) return;

      if(payload.profile) saveJSON(STORAGE.PROFILE, payload.profile);
      if(Array.isArray(payload.weights)) saveJSON(STORAGE.WEIGHTS, payload.weights);
      if(payload.mealChecks) saveJSON(STORAGE.MEAL_CHECKS, payload.mealChecks);
      if(Array.isArray(payload.walks)) saveJSON(STORAGE.WALKS, payload.walks);
      if(payload.walkActive) saveJSON(STORAGE.WALK_ACTIVE, payload.walkActive);
      if(payload.daily) saveJSON(STORAGE.DAILY, payload.daily);

      stopWatchAndTimer();
      const aw=getActiveWalk();
      if(aw?.active){ beginWatch(); ensureTimer(); }

      toast("good","Import","Termin√© ‚úÖ", 1600);
      render();
    }catch(err){
      toast("bad","Import","√âchec : " + (err?.message||""), 2600);
    }finally{
      e.target.value="";
    }
  });

  $("clearAllBtn")?.addEventListener("click", ()=>{
    if(!confirm("Tout effacer ?")) return;
    Object.values(STORAGE).forEach(del);
    stopWatchAndTimer();
    toast("info","Reset","Donn√©es effac√©es.", 1600);
    render();
  });

  // init date
  if(exists("date")) $("date").value = isoToday();

  // init range UI
  const initRange=loadRange();
  rangeSeg?.querySelectorAll("button").forEach(b=>{
    b.classList.toggle("active", b.getAttribute("data-range")===initRange);
  });

  // resume active walk
  const aw=getActiveWalk();
  if(aw?.active){
    beginWatch();
    ensureTimer();
  }

  render();
});
</script>
</body>
</html>
