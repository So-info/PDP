<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#FF2D55" />
  <title>Nounours Coaching‚Äî Perte de poids (iPhone)</title>
  <style>
    :root{
      --bg:#F2F2F7;
      --card:#FFFFFF;
      --text:#111827;
      --muted:rgba(17,24,39,.56);
      --line:rgba(17,24,39,.10);
      --shadow: 0 12px 32px rgba(0,0,0,.06);
      --r:18px;

      --accent:#FF2D55;
      --accent2:#FF3B30;
      --accent3:#FF9F0A;

      --good:#16A34A;
      --warn:#FF9F0A;
      --bad:#DC2626;

      --tabH: 76px;
      --blur: blur(18px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text",system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      /* IMPORTANT iPhone: garde le bas visible malgr√© la barre fixe */
      padding-bottom: calc(var(--tabH) + env(safe-area-inset-bottom));
      overscroll-behavior-y: none;
    }

    /* ===== Header sticky (ne casse pas le scroll) ===== */
    header{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(242,242,247,.88);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border-bottom: 1px solid var(--line);
      transform: translateZ(0);
    }
    .headerInner{
      max-width: 980px;
      margin: 0 auto;
      padding: calc(10px + env(safe-area-inset-top)) 14px 10px;
    }
    .headerTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .titleBlock{min-width:0}
    .title{
      margin:0;
      font-size: 26px;
      font-weight: 950;
      letter-spacing: -.4px;
      line-height: 1.05;
    }
    .subtitle{
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.25;
    }
    .pill{
      min-width: 138px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      border:1px solid var(--line);
      box-shadow: 0 10px 22px rgba(0,0,0,.05);
      text-align: right;
      flex: 0 0 auto;
    }
    .pill .lbl{font-size:11px;color:var(--muted)}
    .pill .val{margin-top:3px;font-size:16px;font-weight:950;white-space:nowrap}

    /* Rings row */
    .ringsRow{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    .ringCard{
      display:flex; align-items:center; gap:10px;
      padding: 10px 10px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 22px rgba(0,0,0,.05);
      min-width:0;
    }
    .ringSvg{width:42px;height:42px;flex:0 0 42px}
    .ringMeta{min-width:0}
    .ringTitle{font-size:12px;color:var(--muted);font-weight:900}
    .ringValue{
      margin-top:2px;
      font-size:13px;
      font-weight:950;
      line-height:1.2;
      white-space: normal;     /* ‚úÖ lisible en entier */
      overflow: visible;
      word-break: break-word;
    }

    /* Compact mode en scroll */
    header.compact .title{font-size:20px}
    header.compact .subtitle{display:none}
    header.compact .pill{padding:8px 10px; min-width:128px}
    header.compact .ringsRow{gap:8px}
    header.compact .ringCard{padding:8px 8px;border-radius:14px}
    header.compact .ringSvg{width:38px;height:38px;flex-basis:38px}

    @media (max-width: 420px){
      .pill{min-width:128px}
      .title{font-size:24px}
    }

    /* ===== Layout ===== */
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 12px 14px 16px;
    }
    .stack{display:grid; gap:12px}
    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
      min-width: 0;
    }
    .tiny{font-size:12px;color:var(--muted);line-height:1.35}
    .muted{color:var(--muted)}
    .pos{color:var(--good)} .neg{color:var(--bad)}

    /* Form grid (√©vite chevauchements sur iPhone) */
    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      align-items: end;
    }
    @media (max-width: 560px){
      .formGrid{grid-template-columns: 1fr}
      .formGrid .btnFull{width:100%}
    }

    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}

    input, select, textarea{
      width:100%;
      border-radius:14px;
      border: 1px solid var(--line);
      background:#fff;
      padding: 11px 12px;
      font-size:16px;
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(255,45,85,.45);
      box-shadow: 0 0 0 3px rgba(255,45,85,.12);
    }

    button{
      border:none;
      border-radius:14px;
      padding: 12px 14px;
      background: var(--accent);
      color:#fff;
      font-weight:950;
      cursor:pointer;
      box-shadow: 0 12px 22px rgba(255,45,85,.18);
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }
    button:active{transform: translateY(1px)}
    button.secondary{
      background:#fff;
      color: var(--text);
      border: 1px solid var(--line);
      box-shadow:none;
      font-weight:900;
    }
    button.ghost{
      background: transparent;
      border: 1px solid var(--line);
      color: var(--text);
      box-shadow:none;
      font-weight:900;
    }
    button:disabled{opacity:.55;cursor:not-allowed;box-shadow:none}

    /* Sections */
    .section{display:none}
    .section.active{display:block}

    /* ===== Highlights (propre et lisible) ===== */
    .highGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media(min-width:820px){
      .highGrid{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
    .hCard{
      border:1px solid var(--line);
      border-radius: 18px;
      background:#fff;
      padding: 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.04);
      min-width:0;
    }
    .hTitle{font-size:12px;color:var(--muted);font-weight:950}
    .hBig{margin-top:6px;font-size:22px;font-weight:950;letter-spacing:-.3px}
    .hSub{margin-top:4px;font-size:12px;color:var(--muted);line-height:1.35}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding: 7px 10px;
      border-radius:999px;
      border: 1px solid var(--line);
      background: rgba(255,45,85,.06);
      font-size:12px;
      color: rgba(17,24,39,.78);
      white-space: nowrap;
      margin-top: 10px;
    }

    /* Coach action row */
    .ctaRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .ctaRow > *{flex: 1 1 200px}

    /* Meals */
    .mealGrid{display:grid;gap:10px}
    @media(min-width:820px){.mealGrid{grid-template-columns: 1fr 1fr}}
    .mealCard{
      border:1px solid var(--line);
      border-radius:18px;
      background:#fff;
      padding:12px;
      min-width:0;
    }
    .mealHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .mealTitle{font-weight:950}
    .dayLabel{font-size:12px;color:var(--muted)}
    .check{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);user-select:none;white-space:nowrap}
    .check input{width:22px;height:22px}

    .item{display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-top:1px dashed rgba(17,24,39,.10)}
    .item:first-of-type{border-top:none}
    .left{display:flex;gap:10px;min-width:0}
    .icon{
      width:36px;height:36px;border-radius:14px;
      background:rgba(255,45,85,.08);
      border:1px solid rgba(255,45,85,.14);
      display:flex;align-items:center;justify-content:center;
      flex: 0 0 36px;
      font-size:18px;
    }
    .item b{display:block}
    .item .sub{font-size:12px;color:var(--muted);line-height:1.25}

    /* Movement timer */
    .timerBig{
      font-size: 34px;
      font-weight: 950;
      letter-spacing: -0.6px;
      margin-top: 4px;
    }
    .barWrap{
      margin-top: 10px;
      height: 10px;
      background: rgba(17,24,39,.08);
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid var(--line);
    }
    .barFill{
      height:100%;
      width: 0%;
      background: rgba(255,45,85,.85);
      border-radius: 999px;
    }

    /* Chart */
    canvas{
      width:100%;
      height: 240px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
    }

    /* Bottom Tab Bar */
    .tabbar{
      position: fixed;
      left:0; right:0; bottom:0;
      height: calc(var(--tabH) + env(safe-area-inset-bottom));
      padding-bottom: env(safe-area-inset-bottom);
      background: rgba(242,242,247,.92);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border-top: 1px solid var(--line);
      z-index: 60;
      transform: translateZ(0);
    }
    .tabInner{
      max-width: 980px;
      margin: 0 auto;
      height: var(--tabH);
      padding: 8px 10px 10px;
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap: 8px;
    }
    .tabBtn{
      width:100%;
      border-radius: 14px;
      border: 1px solid transparent;
      background: transparent;
      color: rgba(17,24,39,.55);
      box-shadow: none;
      padding: 10px 8px;
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      gap:4px;
      font-weight: 900;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .tabBtn .ico{font-size:18px;line-height:1}
    .tabBtn .txt{font-size:11px;line-height:1}
    .tabBtn.active{
      background:#fff;
      border-color: var(--line);
      box-shadow: 0 10px 22px rgba(0,0,0,.05);
      color: var(--text);
    }

    /* Toasts */
    .toasts{
      position: fixed;
      right: 14px;
      bottom: calc(var(--tabH) + 14px + env(safe-area-inset-bottom));
      z-index: 9999;
      display:flex;
      flex-direction: column;
      gap: 10px;
      width: min(380px, calc(100vw - 28px));
      pointer-events: none;
    }
    .toast{
      pointer-events:auto;
      border-radius: 18px;
      padding: 12px 12px;
      background: #fff;
      border: 1px solid var(--line);
      box-shadow: 0 18px 50px rgba(0,0,0,.12);
      display:flex; gap: 10px; align-items:flex-start;
      transform: translateY(8px);
      opacity: 0;
      animation: toastIn .18s ease forwards;
    }
    @keyframes toastIn{to{transform:translateY(0);opacity:1}}
    .toast .ico{
      width:36px;height:36px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(255,45,85,.08);
      border:1px solid rgba(255,45,85,.14);
      flex:0 0 36px;
    }
    .toast .title{font-weight:950}
    .toast .msg{font-size:12px;color:var(--muted);margin-top:2px;line-height:1.35}
    .toast .x{
      margin-left:auto;background:transparent;border:none;cursor:pointer;
      color:var(--muted);font-weight:950;box-shadow:none;padding:0;
    }
    .toast.good .ico{background:rgba(22,163,74,.10);border-color:rgba(22,163,74,.18)}
    .toast.bad  .ico{background:rgba(220,38,38,.10);border-color:rgba(220,38,38,.18)}

    /* Bottom sheet (anti-fringale) */
    .sheetBack{
      position:fixed; inset:0; z-index:120;
      background: rgba(0,0,0,.28);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
    }
    .sheetBack.show{opacity:1; pointer-events:auto}
    .sheet{
      position:fixed; left:0; right:0; bottom:0; z-index:121;
      background: rgba(255,255,255,.96);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border-top:1px solid var(--line);
      border-radius: 18px 18px 0 0;
      transform: translateY(110%);
      transition: transform .22s ease;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .sheet.show{transform: translateY(0)}
    .sheetInner{
      max-width: 980px;
      margin: 0 auto;
      padding: 10px 14px 14px;
    }
    .grab{
      width: 42px; height: 5px;
      border-radius: 999px;
      background: rgba(17,24,39,.15);
      margin: 6px auto 10px;
    }
    .sheetTitle{
      font-weight: 950;
      font-size: 16px;
      letter-spacing: -.2px;
      margin: 0;
    }
    .sheetSub{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35}
    .sheetList{display:grid;gap:10px;margin-top:12px}
    .sheetItem{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.04);
    }
    .sheetItem b{display:block}
    .sheetItem .sub{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.35}
  </style>
</head>

<body>
<header id="appHeader">
  <div class="headerInner">
    <div class="headerTop">
      <div class="titleBlock">
        <h1 class="title" id="headerTitle">Nounours Coaching</h1>
        <div class="subtitle" id="headerSubtitle">Objectif : gagner ta journ√©e, sans sport.</div>
      </div>
      <div class="pill">
        <div class="lbl">Poids actuel</div>
        <div class="val" id="headerPill">‚Äî</div>
      </div>
    </div>

    <div class="ringsRow" aria-label="Objectifs du jour">
      <div class="ringCard">
        <svg class="ringSvg" viewBox="0 0 44 44" aria-hidden="true">
          <circle cx="22" cy="22" r="18" fill="none" stroke="rgba(17,24,39,.10)" stroke-width="6"></circle>
          <circle id="ringMeals" cx="22" cy="22" r="18" fill="none" stroke="var(--accent)" stroke-width="6"
                  stroke-linecap="round" transform="rotate(-90 22 22)"
                  stroke-dasharray="113.1" stroke-dashoffset="113.1"></circle>
        </svg>
        <div class="ringMeta">
          <div class="ringTitle">Repas</div>
          <div class="ringValue" id="ringMealsText">‚Äî</div>
        </div>
      </div>

      <div class="ringCard">
        <svg class="ringSvg" viewBox="0 0 44 44" aria-hidden="true">
          <circle cx="22" cy="22" r="18" fill="none" stroke="rgba(17,24,39,.10)" stroke-width="6"></circle>
          <circle id="ringMove" cx="22" cy="22" r="18" fill="none" stroke="var(--accent3)" stroke-width="6"
                  stroke-linecap="round" transform="rotate(-90 22 22)"
                  stroke-dasharray="113.1" stroke-dashoffset="113.1"></circle>
        </svg>
        <div class="ringMeta">
          <div class="ringTitle">Mouvement</div>
          <div class="ringValue" id="ringMoveText">‚Äî</div>
        </div>
      </div>

      <div class="ringCard">
        <svg class="ringSvg" viewBox="0 0 44 44" aria-hidden="true">
          <circle cx="22" cy="22" r="18" fill="none" stroke="rgba(17,24,39,.10)" stroke-width="6"></circle>
          <circle id="ringWeigh" cx="22" cy="22" r="18" fill="none" stroke="var(--accent2)" stroke-width="6"
                  stroke-linecap="round" transform="rotate(-90 22 22)"
                  stroke-dasharray="113.1" stroke-dashoffset="113.1"></circle>
        </svg>
        <div class="ringMeta">
          <div class="ringTitle">Pes√©e</div>
          <div class="ringValue" id="ringWeighText">‚Äî</div>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="toasts" id="toasts"></div>

<!-- Anti-fringale sheet -->
<div class="sheetBack" id="sheetBack"></div>
<div class="sheet" id="sheet">
  <div class="sheetInner">
    <div class="grab"></div>
    <h3 class="sheetTitle">Anti-fringale (2 minutes)</h3>
    <div class="sheetSub" id="sheetSub">On choisit une option facile. Le but : √©viter ‚Äúje craque‚Äù.</div>
    <div class="sheetList" id="sheetList"></div>
    <div class="ctaRow" style="margin-top:12px">
      <button class="secondary" id="sheetCloseBtn" type="button">Fermer</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="stack">

    <!-- ===== Aujourd‚Äôhui ===== -->
    <section class="section active" id="secToday">
      <div class="card">
        <div class="formGrid">
          <div>
            <label>Date</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label>Poids du jour (kg)</label>
            <input id="weight" type="number" step="0.1" inputmode="decimal" placeholder="ex: 114.6" />
          </div>
          <div>
            <button class="btnFull" id="saveWeightBtn" type="button">Ajouter</button>
          </div>
        </div>
        <div class="tiny" style="margin-top:8px">
          R√®gle d‚Äôor : une journ√©e ‚Äúgagn√©e‚Äù = <b>2 objectifs sur 3</b>. Pas besoin d‚Äô√™tre parfait.
        </div>
      </div>

      <div class="card">
        <div class="highGrid">
          <div class="hCard">
            <div class="hTitle">Score du jour</div>
            <div class="hBig" id="hScore">‚Äî</div>
            <div class="hSub" id="hScoreSub">‚Äî</div>
            <div class="chip" id="hNext">‚ú® Prochaine action</div>
          </div>

          <div class="hCard">
            <div class="hTitle">Tendance (moyenne 7 jours)</div>
            <div class="hBig" id="hTrend">‚Äî</div>
            <div class="hSub" id="hTrendSub">‚Äî</div>
          </div>

          <div class="hCard">
            <div class="hTitle">Poids & moyenne</div>
            <div class="hBig" id="hNow">‚Äî</div>
            <div class="hSub" id="hNowSub">‚Äî</div>
          </div>

          <div class="hCard">
            <div class="hTitle">Projection</div>
            <div class="hBig" id="hETA">‚Äî</div>
            <div class="hSub" id="hETASub">‚Äî</div>
          </div>
        </div>

        <div class="ctaRow">
          <button id="nextActionBtn" type="button">‚ñ∂Ô∏é Faire la prochaine action</button>
          <button class="ghost" id="cravingBtn" type="button">üç´ J‚Äôai envie de grignoter</button>
        </div>

        <div class="tiny" id="coachLine" style="margin-top:10px"></div>

        <div style="margin-top:12px">
          <canvas id="chart" width="1000" height="360"></canvas>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px;font-size:15px">üçΩÔ∏è Repas d‚Äôaujourd‚Äôhui</h2>
        <div class="mealGrid" id="todayMeals"></div>
      </div>
    </section>

    <!-- ===== Repas ===== -->
    <section class="section" id="secMeals">
      <div class="card">
        <h2 style="margin:0 0 10px;font-size:15px">üçΩÔ∏è Repas (plan ‚Äúanti-d√©cision‚Äù)</h2>
        <div class="tiny">
          Le but : <b>prot√©ines + volume</b> ‚Üí tu manges, tu calmes la faim, tu avances.
        </div>

        <div class="formGrid" style="grid-template-columns:1fr 1fr; margin-top:10px">
          <div>
            <label>Mode repas</label>
            <select id="mealMode">
              <option value="simple" selected>Ultra simple</option>
              <option value="normal">Normal</option>
              <option value="social">Social (week-end)</option>
            </select>
          </div>
          <div>
            <label>Prot√©ine pr√©f√©r√©e</label>
            <select id="proteinPref">
              <option value="Poulet" selected>Poulet</option>
              <option value="≈íufs">≈íufs</option>
              <option value="Thon">Thon</option>
              <option value="Skyr">Skyr</option>
              <option value="Sardines">Sardines</option>
            </select>
          </div>
        </div>

        <div class="ctaRow">
          <button id="cravingBtn2" type="button">üç´ Anti-fringale</button>
          <button class="secondary" id="resetChecksBtn" type="button">R√©initialiser les coches</button>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px;font-size:15px">üìÖ Semaine</h2>
        <div class="mealGrid" id="weekMeals"></div>
      </div>
    </section>

    <!-- ===== Mouvement ===== -->
    <section class="section" id="secMove">
      <div class="card">
        <h2 style="margin:0 0 10px;font-size:15px">üö∂ Mouvement (z√©ro sport)</h2>
        <div class="tiny">
          Objectif = <b>10 minutes</b>. Si tu es KO : <b>2 minutes</b> ‚Üí √ßa relance.
        </div>

        <div style="margin-top:10px">
          <div class="tiny muted">Timer</div>
          <div class="timerBig" id="moveTimer">00:00</div>
          <div class="barWrap"><div class="barFill" id="moveBar"></div></div>
          <div class="tiny" style="margin-top:8px" id="moveMeta">‚Äî</div>
        </div>

        <div class="ctaRow">
          <button id="moveStartBtn" type="button">D√©marrer</button>
          <button class="secondary" id="moveStopBtn" type="button" disabled>Stop</button>
          <button class="ghost" id="moveAdd5Btn" type="button">+5 min (manuel)</button>
        </div>

        <div class="ctaRow">
          <button class="secondary" id="move2minBtn" type="button">Mode KO : 2 minutes</button>
          <button class="secondary" id="move10minBtn" type="button">Objectif : 10 minutes</button>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px;font-size:15px">üßæ Historique (7 jours)</h2>
        <div class="tiny" id="moveHistory">‚Äî</div>
      </div>
    </section>

    <!-- ===== Progression ===== -->
    <section class="section" id="secProgress">
      <div class="card">
        <h2 style="margin:0 0 10px;font-size:15px">üìà Progression</h2>
        <div class="highGrid">
          <div class="hCard">
            <div class="hTitle">Jours gagn√©s (7 derniers)</div>
            <div class="hBig" id="pWin7">‚Äî</div>
            <div class="hSub" id="pWin7Sub">‚Äî</div>
          </div>
          <div class="hCard">
            <div class="hTitle">S√©rie pes√©e</div>
            <div class="hBig" id="pStreak">‚Äî</div>
            <div class="hSub">La constance bat la motivation.</div>
          </div>
          <div class="hCard">
            <div class="hTitle">XP / Niveau</div>
            <div class="hBig" id="pXP">‚Äî</div>
            <div class="hSub" id="pXPSub">‚Äî</div>
          </div>
          <div class="hCard">
            <div class="hTitle">Perte totale</div>
            <div class="hBig" id="pLost">‚Äî</div>
            <div class="hSub" id="pLostSub">‚Äî</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== Profil ===== -->
    <section class="section" id="secProfile">
      <div class="card">
        <h2 style="margin:0 0 10px;font-size:15px">üë§ Profil</h2>
        <div class="formGrid" style="grid-template-columns:1fr 1fr">
          <div>
            <label>Taille (cm)</label>
            <input id="height" type="number" step="1" inputmode="numeric" placeholder="173" />
          </div>
          <div>
            <label>Poids de d√©part (kg)</label>
            <input id="startWeight" type="number" step="0.1" inputmode="decimal" placeholder="115" />
          </div>
        </div>

        <div class="formGrid" style="grid-template-columns:1fr 1fr; margin-top:10px">
          <div>
            <label>Objectif (kg)</label>
            <input id="targetWeight" type="number" step="0.1" inputmode="decimal" placeholder="85" />
          </div>
          <div>
            <label>Objectif mouvement / jour (min)</label>
            <input id="moveGoalMin" type="number" step="1" inputmode="numeric" placeholder="10" />
          </div>
        </div>

        <div class="formGrid" style="grid-template-columns:1fr 1fr; margin-top:10px">
          <div>
            <label>Mode pes√©e</label>
            <select id="weighMode">
              <option value="daily" selected>Quotidien</option>
              <option value="3x">3√ó / semaine</option>
              <option value="weekly">1√ó / semaine</option>
            </select>
          </div>
          <div>
            <label>Objectif repas / jour</label>
            <select id="mealGoal">
              <option value="2" selected>2 repas (simple)</option>
              <option value="3">3 repas</option>
            </select>
          </div>
        </div>

        <div class="tiny" style="margin-top:10px">
          Donn√©es stock√©es sur l‚Äôappareil. Fais un backup si tu changes d‚ÄôiPhone.
        </div>

        <div class="ctaRow">
          <button id="saveProfileBtn" type="button">Enregistrer</button>
          <button class="secondary" id="exportBackupBtn" type="button">Backup (JSON)</button>
          <button class="secondary" id="importBackupBtn" type="button">Importer</button>
          <button class="secondary" id="clearAllBtn" type="button">Tout effacer</button>
        </div>

        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>
    </section>

  </div>
</div>

<nav class="tabbar" aria-label="Navigation">
  <div class="tabInner">
    <button class="tabBtn active" id="tabToday" type="button"><div class="ico">üè†</div><div class="txt">Aujourd‚Äôhui</div></button>
    <button class="tabBtn" id="tabMeals" type="button"><div class="ico">üçΩÔ∏è</div><div class="txt">Repas</div></button>
    <button class="tabBtn" id="tabMove" type="button"><div class="ico">üö∂</div><div class="txt">Bouger</div></button>
    <button class="tabBtn" id="tabProgress" type="button"><div class="ico">üìà</div><div class="txt">Progr√®s</div></button>
    <button class="tabBtn" id="tabProfile" type="button"><div class="ico">üë§</div><div class="txt">Profil</div></button>
  </div>
</nav>

<script>
document.addEventListener("DOMContentLoaded", () => {
  window.addEventListener("error", (e) => alert("Erreur JS :\n" + (e?.message || "inconnue")));

  (function(){
    "use strict";

    /* ===== Storage ===== */
    const STORAGE = {
      PROFILE: "coach30_profile_v1",
      WEIGHTS: "coach30_weights_v1",
      MEAL_CHECKS: "coach30_meal_checks_v1",
      MOVES: "coach30_moves_v1",        // { "YYYY-MM-DD": minutesNumber }
      XP: "coach30_xp_v1",              // number
      WINS: "coach30_wins_v1",          // { "YYYY-MM-DD": {mealsOk, moveOk, weighOk, win} }
    };

    const DEFAULT_PROFILE = {
      heightCm: 173,
      startWeight: 115.0,
      targetWeight: 85.0,
      moveGoalMin: 10,     // sans sport -> 10 min
      weighMode: "daily",
      mealGoal: 2,
      mealMode: "simple",
      proteinPref: "Poulet",
    };

    const MOTIVATION = [
      "Objectif : 2/3. Pas parfait. Juste constant.",
      "Une journ√©e gagn√©e vaut plus qu‚Äôune journ√©e parfaite.",
      "La moyenne 7 jours > le chiffre du jour.",
      "Quand c‚Äôest dur : fais petit. Mais fais."
    ];

    /* ===== DOM helpers ===== */
    const $ = (id)=>document.getElementById(id);
    const exists = (id)=>!!document.getElementById(id);
    const clamp = (v,min,max)=>Math.max(min, Math.min(max, v));
    const pad2 = (n)=>String(n).padStart(2,"0");

    function fmt(n,d=1){
      if(n===null||n===undefined||n==="") return "‚Äî";
      const x=Number(n);
      if(Number.isNaN(x)) return "‚Äî";
      return x.toFixed(d);
    }

    function isoToday(){
      const d=new Date();
      const tz=d.getTimezoneOffset()*60000;
      return new Date(d - tz).toISOString().slice(0,10);
    }
    function addDays(iso,n){
      const d=new Date(iso+"T00:00:00");
      d.setDate(d.getDate()+n);
      const tz=d.getTimezoneOffset()*60000;
      return new Date(d - tz).toISOString().slice(0,10);
    }
    function dayName(iso){
      const d=new Date(iso+"T00:00:00");
      return ["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"][d.getDay()];
    }

    function loadJSON(key, fallback){
      try{ const v=localStorage.getItem(key); return v?JSON.parse(v):fallback; }
      catch{ return fallback; }
    }
    function saveJSON(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
    function del(key){ localStorage.removeItem(key); }

    /* ===== Toasts ===== */
    function toast(type, title, msg, ms=1800){
      const box=$("toasts"); if(!box) return;
      const el=document.createElement("div");
      el.className="toast "+(type||"");
      const ico = type==="good"?"‚úÖ":type==="bad"?"‚õî":"‚ú®";
      el.innerHTML = `
        <div class="ico">${ico}</div>
        <div style="min-width:0">
          <div class="title">${title||"Info"}</div>
          <div class="msg">${msg||""}</div>
        </div>
        <button class="x" type="button">‚úï</button>
      `;
      const kill=()=>{ el.style.opacity="0"; el.style.transform="translateY(8px)"; setTimeout(()=>el.remove(), 180); };
      el.querySelector(".x").addEventListener("click", kill);
      box.appendChild(el);
      if(ms>0) setTimeout(kill, ms);
      try{ if(navigator.vibrate) navigator.vibrate(type==="bad"?[10,20,10]:18); }catch{}
    }

    /* ===== Profile ===== */
    function loadProfile(){
      let p = loadJSON(STORAGE.PROFILE, null);
      if(!p){ p = DEFAULT_PROFILE; saveJSON(STORAGE.PROFILE, p); }
      // patch
      p.heightCm ??= DEFAULT_PROFILE.heightCm;
      p.startWeight ??= DEFAULT_PROFILE.startWeight;
      p.targetWeight ??= DEFAULT_PROFILE.targetWeight;
      p.moveGoalMin ??= DEFAULT_PROFILE.moveGoalMin;
      p.weighMode ??= DEFAULT_PROFILE.weighMode;
      p.mealGoal ??= DEFAULT_PROFILE.mealGoal;
      p.mealMode ??= DEFAULT_PROFILE.mealMode;
      p.proteinPref ??= DEFAULT_PROFILE.proteinPref;
      return p;
    }

    /* ===== Weights ===== */
    function loadWeights(){
      const rows = loadJSON(STORAGE.WEIGHTS, []);
      return Array.isArray(rows)
        ? rows.filter(r=>r && r.date && typeof r.date==="string" && typeof r.weight==="number")
              .sort((a,b)=>a.date.localeCompare(b.date))
        : [];
    }
    function saveWeight(dateISO, weight){
      const rows = loadWeights();
      const idx = rows.findIndex(r=>r.date===dateISO);
      const row = {date:dateISO, weight:Number(weight)};
      if(idx>=0) rows[idx]=row; else rows.push(row);
      rows.sort((a,b)=>a.date.localeCompare(b.date));
      saveJSON(STORAGE.WEIGHTS, rows);
    }

    function computeStats(profile, rows){
      const current = rows.length ? rows[rows.length-1].weight : null;
      const lost = (current!=null) ? (Number(profile.startWeight) - current) : null;

      const last7 = rows.slice(-7).map(r=>r.weight);
      const avg7 = last7.length ? last7.reduce((a,b)=>a+b,0)/last7.length : null;

      const prev7 = rows.slice(-14,-7).map(r=>r.weight);
      const avgPrev7 = prev7.length ? prev7.reduce((a,b)=>a+b,0)/prev7.length : null;

      return {current,lost,avg7,avgPrev7,count:rows.length};
    }

    function computeWeighStreak(rows){
      const dates = rows.map(r=>r.date).sort();
      if(!dates.length) return 0;
      let streak=1;
      for(let i=dates.length-1;i>0;i--){
        const d1=new Date(dates[i]+"T00:00:00");
        const d0=new Date(dates[i-1]+"T00:00:00");
        const diff=Math.round((d1-d0)/(24*3600*1000));
        if(diff===1) streak++;
        else if(diff===0) continue;
        else break;
      }
      return streak;
    }

    function estimateETA(profile, stats){
      const tw = Number(profile.targetWeight);
      const cur = stats.current;
      if(cur==null || Number.isNaN(tw)) return null;
      const remaining = cur - tw;
      if(remaining<=0) return {text:"Objectif atteint", date:null};

      if(stats.avg7==null || stats.avgPrev7==null) return {text:"Ajoute des donn√©es", date:null};

      const weeklyLoss = (stats.avgPrev7 - stats.avg7);
      if(weeklyLoss <= 0.05) return {text:"Tendance stable", date:null};

      const weeks = remaining / weeklyLoss;
      const days = Math.ceil(weeks*7);
      const eta = new Date();
      eta.setDate(eta.getDate()+days);
      return {text:`‚âà ${days} jours`, date:eta, weeklyLoss};
    }

    /* ===== Meals checks ===== */
    function mealKey(dateISO, type){ return dateISO+"_"+type; } // lunch/dinner
    function loadMealChecks(){ return loadJSON(STORAGE.MEAL_CHECKS, {}); }
    function saveMealChecks(st){ saveJSON(STORAGE.MEAL_CHECKS, st); }
    function mealsDone(dateISO){
      const st=loadMealChecks();
      const a=!!st[mealKey(dateISO,"lunch")];
      const b=!!st[mealKey(dateISO,"dinner")];
      return (a?1:0)+(b?1:0);
    }

    /* ===== Moves minutes ===== */
    function loadMoves(){ return loadJSON(STORAGE.MOVES, {}); } // map date -> minutes
    function saveMoves(m){ saveJSON(STORAGE.MOVES, m); }
    function addMoveMinutes(dateISO, minutes){
      const m=loadMoves();
      m[dateISO] = Math.max(0, Math.round((Number(m[dateISO])||0) + Number(minutes)));
      saveMoves(m);
    }
    function getMoveMinutes(dateISO){
      const m=loadMoves();
      return Number(m[dateISO])||0;
    }

    /* ===== Wins + XP ===== */
    function loadWins(){ return loadJSON(STORAGE.WINS, {}); }
    function saveWins(w){ saveJSON(STORAGE.WINS, w); }
    function loadXP(){ return Number(loadJSON(STORAGE.XP, 0))||0; }
    function saveXP(x){ saveJSON(STORAGE.XP, Number(x)||0); }

    function computeDayStatus(dateISO, profile){
      const rows = loadWeights();
      const hasWeigh = !!rows.find(r=>r.date===dateISO);
      const mealGoal = Number(profile.mealGoal)||2;
      const mealsOk = mealsDone(dateISO) >= mealGoal;
      const moveOk = getMoveMinutes(dateISO) >= (Number(profile.moveGoalMin)||10);

      // mode pes√©e : daily / 3x / weekly -> on consid√®re "ok" si pes√©e faite OU non requise ce jour
      let weighRequired = true;
      if(profile.weighMode==="3x"){
        // Lun/Mer/Ven par ex
        const d=new Date(dateISO+"T00:00:00").getDay(); // 0..6
        weighRequired = (d===1 || d===3 || d===5);
      }else if(profile.weighMode==="weekly"){
        // Lundi
        const d=new Date(dateISO+"T00:00:00").getDay();
        weighRequired = (d===1);
      }
      const weighOk = weighRequired ? hasWeigh : true;

      const done = (mealsOk?1:0) + (moveOk?1:0) + (weighOk?1:0);
      const win = done>=2;

      return {mealsOk, moveOk, weighOk, hasWeigh, weighRequired, done, total:3, win, mealGoal};
    }

    function syncWinAndXP(dateISO){
      const profile=loadProfile();
      const status=computeDayStatus(dateISO, profile);
      const wins=loadWins();
      const prev = wins[dateISO];
      wins[dateISO] = { ...status, date: dateISO };
      saveWins(wins);

      // XP: +10 par objectif atteint (max 30) mais seulement une fois / jour
      // si d√©j√† calcul√© avant, on ajuste
      const prevXP = prev ? ( (prev.mealsOk?10:0)+(prev.moveOk?10:0)+(prev.weighOk?10:0) ) : 0;
      const newXP  = (status.mealsOk?10:0)+(status.moveOk?10:0)+(status.weighOk?10:0);
      const delta = newXP - prevXP;
      if(delta!==0){
        saveXP(loadXP()+delta);
      }
      return status;
    }

    function levelFromXP(xp){
      // niveaux simples
      const lvl = Math.floor(xp/120)+1;
      const next = lvl*120;
      const pct = clamp((xp - (lvl-1)*120)/120*100, 0, 100);
      return {lvl, next, pct};
    }

    /* ===== Rings ===== */
    function setRing(circleId, pct){
      const el=$(circleId); if(!el) return;
      const C=113.1;
      const p=clamp(Number(pct)||0, 0, 100);
      el.style.strokeDasharray = String(C);
      el.style.strokeDashoffset = String(C*(1-p/100));
    }

    /* ===== Chart ===== */
    function drawChart(profile, rows){
      const c=$("chart"); if(!c) return;
      const ctx=c.getContext("2d");
      const W=c.width, H=c.height;
      ctx.clearRect(0,0,W,H);

      ctx.fillStyle="#fff"; ctx.fillRect(0,0,W,H);
      ctx.strokeStyle="rgba(17,24,39,.08)";
      ctx.strokeRect(0.5,0.5,W-1,H-1);

      if(rows.length<2){
        ctx.fillStyle="rgba(17,24,39,.55)";
        ctx.font="13px -apple-system, system-ui";
        ctx.fillText("Ajoute 2 pes√©es pour voir la courbe.", 16, 28);
        return;
      }

      const padL=56,padR=16,padT=14,padB=34;
      const plotW=W-padL-padR, plotH=H-padT-padB;

      const data = rows.map(r=>({x:new Date(r.date+"T00:00:00").getTime(), y:r.weight}))
                       .sort((a,b)=>a.x-b.x);

      const minX=data[0].x, maxX=data[data.length-1].x;
      const ys=data.map(p=>p.y);
      let minY=Math.min(...ys), maxY=Math.max(...ys);
      const margin=Math.max(0.8,(maxY-minY)*0.20);
      minY-=margin; maxY+=margin;

      const xToPx=x=>padL+((x-minX)/(maxX-minX))*plotW;
      const yToPx=y=>padT+(1-((y-minY)/(maxY-minY)))*plotH;

      // grid
      ctx.strokeStyle="rgba(17,24,39,.06)";
      ctx.lineWidth=1;
      ctx.font="12px -apple-system, system-ui";
      ctx.fillStyle="rgba(17,24,39,.45)";
      for(let i=0;i<=4;i++){
        const t=i/4;
        const yVal=maxY-t*(maxY-minY);
        const y=yToPx(yVal);
        ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
        ctx.fillText(yVal.toFixed(1), 12, y+4);
      }

      // target line
      const tw=Number(profile.targetWeight);
      if(!Number.isNaN(tw)){
        const yT=yToPx(tw);
        ctx.setLineDash([6,6]);
        ctx.strokeStyle="rgba(255,45,85,.35)";
        ctx.beginPath(); ctx.moveTo(padL,yT); ctx.lineTo(W-padR,yT); ctx.stroke();
        ctx.setLineDash([]);
      }

      // smooth curve
      ctx.strokeStyle="rgba(255,45,85,.95)";
      ctx.lineWidth=2.8;
      ctx.lineJoin="round";
      ctx.lineCap="round";
      ctx.beginPath();
      data.forEach((p,i)=>{
        const x=xToPx(p.x), y=yToPx(p.y);
        if(i===0) ctx.moveTo(x,y);
        else{
          const prev=data[i-1];
          const x0=xToPx(prev.x), y0=yToPx(prev.y);
          const cx=(x0+x)/2;
          ctx.quadraticCurveTo(cx,y0, x,y);
        }
      });
      ctx.stroke();

      // points
      ctx.fillStyle="rgba(255,45,85,1)";
      data.forEach(p=>{
        const x=xToPx(p.x), y=yToPx(p.y);
        ctx.beginPath(); ctx.arc(x,y,3.2,0,Math.PI*2); ctx.fill();
      });

      const last=data[data.length-1];
      ctx.fillStyle="rgba(17,24,39,.78)";
      ctx.font="12px -apple-system, system-ui";
      ctx.fillText(`Dernier: ${last.y.toFixed(1)} kg`, 16, H-12);
    }

    /* ===== UI: Meal cards ===== */
    function buildMealCard(dateISO, type, profile){
      const st=loadMealChecks();
      const key=mealKey(dateISO,type);
      const done=!!st[key];

      const title = type==="lunch" ? "Midi" : "Soir";
      const mode = profile.mealMode || "simple";
      const pref = profile.proteinPref || "Poulet";

      const mealText = (()=>{
        if(mode==="social"){
          return type==="lunch"
            ? ["Prot√©ine + l√©gumes","√âvite boissons sucr√©es","Dessert ? petit ou partag√©"]
            : ["Prot√©ine + l√©ger","Marche 10 min apr√®s si possible","Hydrate-toi"];
        }
        if(mode==="normal"){
          return type==="lunch"
            ? ["Prot√©ine + f√©culent + l√©gumes","Portion simple","Eau"]
            : ["Prot√©ine + l√©gumes","Dessert optionnel : skyr","Stop quand satisfait"];
        }
        // simple
        return type==="lunch"
          ? ["Soupe/volume + prot√©ine", `Prot√©ine: ${pref}`, "1 c. caf√© huile d‚Äôolive si faim"]
          : ["Prot√©ine + l√©ger", `Prot√©ine: ${pref}`, "Pas de grignotage apr√®s"];
      })();

      const el=document.createElement("div");
      el.className="mealCard";
      el.innerHTML = `
        <div class="mealHead">
          <div style="min-width:0">
            <div class="mealTitle">${title}</div>
            <div class="dayLabel">${dayName(dateISO)} ‚Ä¢ ${dateISO}</div>
          </div>
          <label class="check"><input type="checkbox" ${done?"checked":""}/>fait</label>
        </div>

        ${mealText.map((t,i)=>`
          <div class="item">
            <div class="left">
              <div class="icon">${i===0?"ü•£":i===1?"üçó":"‚úÖ"}</div>
              <div style="min-width:0">
                <b>${t}</b>
                <div class="sub">${i===0?"Objectif: volume":i===1?"Objectif: sati√©t√©":"Objectif: constance"}</div>
              </div>
            </div>
          </div>
        `).join("")}
      `;

      const cb=el.querySelector('input[type="checkbox"]');
      cb.addEventListener("change", ()=>{
        const s=loadMealChecks();
        s[key]=cb.checked;
        saveMealChecks(s);
        syncWinAndXP(dateISO);
        toast("good","Repas", cb.checked?"Coch√© ‚úÖ":"D√©coch√©", 1200);
        renderAll();
      });

      return el;
    }

    /* ===== Coach / Next action ===== */
    function coachText(status, profile, stats, dateISO){
      if(!status.hasWeigh && status.weighRequired){
        return "Ta meilleure action maintenant : une pes√©e. 10 secondes. √áa remet le train sur les rails.";
      }
      if(!status.mealsOk){
        return `Objectif repas: coche ${status.mealGoal}/${status.mealGoal}. Reste simple : prot√©ine + volume.`;
      }
      if(!status.moveOk){
        return "Le hack anti-flemme : marche 2 minutes maintenant. Tu verras, tu finiras souvent √† 10.";
      }
      if(stats.avg7==null) return "Continue. Encore quelques donn√©es et on aura une tendance solide.";
      const diff = (stats.current!=null && stats.avg7!=null) ? (stats.current - stats.avg7) : 0;
      if(diff > 0.25) return "Au-dessus de la moyenne 7 jours : c‚Äôest souvent eau/sel/sommeil. On ne panique pas. Constance.";
      if(diff < -0.25) return "Sous la moyenne 7 jours : excellent signal. Ne change rien.";
      return "Journ√©e gagn√©e. Maintiens ce rythme : simple, mesurable, faisable.";
    }

    function nextAction(status){
      if(!status.weighOk) return {type:"weigh", label:"Ajouter la pes√©e"};
      if(!status.mealsOk) return {type:"meals", label:"Cocher les repas"};
      if(!status.moveOk) return {type:"move", label:"D√©marrer 2 minutes"};
      return {type:"win", label:"Journ√©e gagn√©e üéâ"};
    }

    /* ===== Anti-fringale sheet ===== */
    function openSheet(){
      const back=$("sheetBack"), sheet=$("sheet");
      back.classList.add("show");
      sheet.classList.add("show");
    }
    function closeSheet(){
      const back=$("sheetBack"), sheet=$("sheet");
      back.classList.remove("show");
      sheet.classList.remove("show");
    }

    function renderCravingSheet(dateISO){
      const hour = new Date().getHours();
      const late = hour>=21;
      const mid = hour>=15 && hour<21;

      const list = [
        {t:"Option 1 : prot√©ine rapide", d:"Skyr / ≈ìufs / thon. 10 minutes apr√®s, l‚Äôenvie baisse."},
        {t:"Option 2 : volume (croquant)", d:"Carottes/concombres + sel/citron. Tu occupes la bouche sans exploser les calories."},
        {t:"Option 3 : boisson + pause", d:"Grand verre d‚Äôeau ou th√©. Attends 10 minutes. Si l‚Äôenvie reste ‚Üí Option 1."},
      ];

      if(late) list.unshift({t:"Mode soir√©e : coupe le d√©clencheur", d:"Brosse-toi les dents + tisane. Puis √©loigne snacks (hors vue)."});
      if(mid) list.unshift({t:"Mode go√ªter : snack cadr√©", d:"1 fruit + skyr / 1 poign√©e d‚Äôamandes (mesur√©e). Stop apr√®s."});

      const box=$("sheetList");
      box.innerHTML = list.map(x=>`
        <div class="sheetItem">
          <b>${x.t}</b>
          <div class="sub">${x.d}</div>
        </div>
      `).join("");
      $("sheetSub").textContent = `On choisit une option facile. Date: ${dateISO}.`;
    }

    /* ===== Movement timer ===== */
    let tMode = "10"; // "2" or "10"
    let tRunning=false;
    let tStartMs=0;
    let tElapsedMs=0;
    let tTick=null;

    function fmtMMSS(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const m = Math.floor(s/60);
      const ss = s%60;
      return `${pad2(m)}:${pad2(ss)}`;
    }

    function targetMs(){
      const p=loadProfile();
      const base = (tMode==="2") ? 2 : (Number(p.moveGoalMin)||10);
      return base*60*1000;
    }

    function updateTimerUI(dateISO){
      const goalMs=targetMs();
      const curMs=tElapsedMs + (tRunning ? (Date.now()-tStartMs) : 0);
      $("moveTimer").textContent = fmtMMSS(curMs);
      const pct = clamp((curMs/goalMs)*100, 0, 100);
      $("moveBar").style.width = pct.toFixed(0)+"%";

      const goalMin = Math.round(goalMs/60000);
      const doneMin = getMoveMinutes(dateISO);
      $("moveMeta").textContent = `Aujourd‚Äôhui: ${doneMin} min ‚Ä¢ Objectif: ${goalMin} min ‚Ä¢ Mode: ${tMode==="2"?"KO (2 min)":"Objectif"}`;
      $("moveStartBtn").disabled = tRunning;
      $("moveStopBtn").disabled = !tRunning;
    }

    function timerStart(dateISO){
      if(tRunning) return;
      tRunning=true;
      tStartMs=Date.now();
      tTick=setInterval(()=>{
        updateTimerUI(dateISO);
      }, 250);
      toast("info","Mouvement","C‚Äôest parti. M√™me 2 minutes comptent.", 1400);
    }

    function timerStopAndSave(dateISO){
      if(!tRunning) return;
      const addMs = Date.now()-tStartMs;
      tElapsedMs += addMs;
      tRunning=false;
      clearInterval(tTick); tTick=null;

      const minutes = Math.max(0, Math.round(tElapsedMs/60000));
      if(minutes>0){
        addMoveMinutes(dateISO, minutes);
        syncWinAndXP(dateISO);
        toast("good","Mouvement", `+${minutes} min enregistr√©es ‚úÖ`, 1600);
      }else{
        toast("info","Mouvement","Stop. M√™me 30s c‚Äôest un d√©part.", 1400);
      }
      // reset session buffer
      tElapsedMs=0;
      updateTimerUI(dateISO);
      renderAll();
    }

    /* ===== Tabs ===== */
    function setTab(which){
      const map={
        today:["tabToday","secToday"],
        meals:["tabMeals","secMeals"],
        move:["tabMove","secMove"],
        progress:["tabProgress","secProgress"],
        profile:["tabProfile","secProfile"]
      };
      Object.entries(map).forEach(([k,[t,s]])=>{
        $(t).classList.toggle("active", k===which);
        $(s).classList.toggle("active", k===which);
      });
      // petit fix iOS: remonter en haut si besoin
      try{ window.scrollTo({top:0, behavior:"smooth"}); }catch{ window.scrollTo(0,0); }
    }

    /* ===== Header compact on scroll (stable iPhone) ===== */
    function initHeaderCompact(){
      const header=$("appHeader");
      if(!header) return;
      const sentinel=document.createElement("div");
      sentinel.style.height="1px";
      sentinel.style.width="1px";
      header.after(sentinel);

      const io=new IntersectionObserver((entries)=>{
        const e=entries[0];
        header.classList.toggle("compact", !e.isIntersecting);
      }, {threshold:0});
      io.observe(sentinel);
    }

    /* ===== Render ===== */
    function renderHeader(dateISO){
      const p=loadProfile();
      const rows=loadWeights();
      const stats=computeStats(p, rows);

      // subtitle rotating
      const idx=Math.floor(Date.now()/(10*60*1000)) % MOTIVATION.length;
      $("headerSubtitle").textContent = MOTIVATION[idx];

      $("headerPill").textContent = stats.current!=null ? `${fmt(stats.current,1)} kg` : "‚Äî";

      const status=syncWinAndXP(dateISO);

      // Rings values + progress
      const mealGoal=Number(p.mealGoal)||2;
      const md = mealsDone(dateISO);
      const mpct = clamp((md/mealGoal)*100, 0, 100);

      const mv = getMoveMinutes(dateISO);
      const mGoal=Number(p.moveGoalMin)||10;
      const mvPct = clamp((mv/mGoal)*100, 0, 100);

      const weighPct = status.weighOk ? 100 : 0;

      setRing("ringMeals", mpct);
      setRing("ringMove", mvPct);
      setRing("ringWeigh", weighPct);

      $("ringMealsText").textContent = `${md}/${mealGoal} coch√©s`;
      $("ringMoveText").textContent  = `${mv}/${mGoal} min`;
      $("ringWeighText").textContent = status.weighRequired ? (status.hasWeigh ? "faite ‚úÖ" : "√† faire") : "non requis";

      return {p, rows, stats, status};
    }

    function renderToday(dateISO, ctx){
      const {p, rows, stats, status} = ctx;

      // Highlights
      $("hScore").textContent = `${status.done}/3`;
      $("hScoreSub").textContent = `Repas: ${status.mealsOk?"OK":"‚Äî"} ‚Ä¢ Mouvement: ${status.moveOk?"OK":"‚Äî"} ‚Ä¢ Pes√©e: ${status.weighOk?"OK":"‚Äî"}`;

      const action = nextAction(status);
      $("hNext").textContent = "‚ú® " + action.label;

      // Trend
      const trend = (stats.avgPrev7!=null && stats.avg7!=null) ? (stats.avgPrev7 - stats.avg7) : null;
      if(trend==null){
        $("hTrend").textContent="‚Äî";
        $("hTrendSub").textContent="Ajoute plus de pes√©es pour une tendance fiable.";
      }else{
        const dir = trend>0.05 ? "‚¨áÔ∏é" : trend<-0.05 ? "‚¨ÜÔ∏é" : "‚Üí";
        const lbl = trend>0 ? `baisse ${trend.toFixed(1)} kg/sem` : `hausse ${Math.abs(trend).toFixed(1)} kg/sem`;
        $("hTrend").textContent = `${dir} ${lbl}`;
        $("hTrendSub").textContent = "Comparaison des 7 derniers jours vs les 7 pr√©c√©dents.";
      }

      $("hNow").textContent = stats.current!=null ? `${fmt(stats.current,1)} kg` : "‚Äî";
      $("hNowSub").textContent = `Moyenne 7 jours : ${stats.avg7!=null ? fmt(stats.avg7,1)+" kg" : "‚Äî"}`;

      const eta = estimateETA(p, stats);
      if(!eta){
        $("hETA").textContent="‚Äî";
        $("hETASub").textContent="Ajoute des donn√©es pour estimer.";
      }else{
        if(eta.date){
          const d=eta.date.toLocaleDateString("fr-FR",{year:"numeric",month:"short",day:"numeric"});
          $("hETA").textContent=eta.text;
          $("hETASub").textContent=`Objectif vers ${d} (‚âà ${eta.weeklyLoss.toFixed(1)} kg/sem)`;
        }else{
          $("hETA").textContent=eta.text;
          $("hETASub").textContent="On stabilise la routine.";
        }
      }

      $("coachLine").textContent = coachText(status, p, stats, dateISO);

      // Chart
      drawChart(p, rows);

      // Meals today
      const box=$("todayMeals");
      box.innerHTML="";
      box.appendChild(buildMealCard(dateISO,"lunch",p));
      box.appendChild(buildMealCard(dateISO,"dinner",p));

      // Next action button behavior
      $("nextActionBtn").onclick = ()=>{
        const s = syncWinAndXP(dateISO);
        const a = nextAction(s);
        if(a.type==="weigh"){
          try{ $("weight").focus(); }catch{}
          toast("info","Action","Ajoute ta pes√©e.", 1400);
        }else if(a.type==="meals"){
          setTab("meals");
          toast("info","Action","Coche tes repas.", 1400);
        }else if(a.type==="move"){
          setTab("move");
          tMode="2";
          updateTimerUI(dateISO);
          timerStart(dateISO);
        }else{
          toast("good","Bravo","Journ√©e gagn√©e üéâ (2/3)", 1800);
        }
      };
    }

    function renderMeals(dateISO, ctx){
      const {p} = ctx;
      $("mealMode").value = p.mealMode || "simple";
      $("proteinPref").value = p.proteinPref || "Poulet";

      // week
      const week=$("weekMeals");
      week.innerHTML="";
      const start=isoToday();
      for(let i=0;i<7;i++){
        const d=addDays(start,i);
        week.appendChild(buildMealCard(d,"lunch",p));
        week.appendChild(buildMealCard(d,"dinner",p));
      }
    }

    function renderMove(dateISO, ctx){
      const p=ctx.p;
      // ensure timer ui coherent
      updateTimerUI(dateISO);

      // history 7 days
      let lines=[];
      for(let i=6;i>=0;i--){
        const d=addDays(isoToday(), -i);
        const m=getMoveMinutes(d);
        lines.push(`${dayName(d)} ${d} : ${m} min`);
      }
      $("moveHistory").textContent = lines.join(" ‚Ä¢ ");
    }

    function renderProgress(dateISO, ctx){
      const {p, rows, stats} = ctx;
      const wins=loadWins();
      const xp=loadXP();
      const lv=levelFromXP(xp);

      // 7 days wins
      let winCount=0;
      const days=[];
      for(let i=6;i>=0;i--){
        const d=addDays(isoToday(), -i);
        const w=wins[d]?.win ? 1 : 0;
        winCount += w;
        days.push(`${dayName(d)}:${w?"‚úÖ":"‚Äî"}`);
      }
      $("pWin7").textContent = `${winCount}/7`;
      $("pWin7Sub").textContent = days.join("  ");

      const streak=computeWeighStreak(rows);
      $("pStreak").textContent = streak ? `${streak} j` : "‚Äî";

      $("pXP").textContent = `Niv ${lv.lvl} ‚Ä¢ ${xp} XP`;
      $("pXPSub").textContent = `Prochain niveau √† ${lv.next} XP (progression ${lv.pct.toFixed(0)}%).`;

      $("pLost").textContent = (stats.lost!=null) ? `${stats.lost>=0?"+":""}${fmt(stats.lost,1)} kg` : "‚Äî";
      $("pLostSub").textContent = `D√©part: ${fmt(p.startWeight,1)} ‚Ä¢ Objectif: ${fmt(p.targetWeight,1)}.`;
    }

    function renderProfile(dateISO, ctx){
      const p=ctx.p;
      $("height").value = p.heightCm ?? "";
      $("startWeight").value = p.startWeight ?? "";
      $("targetWeight").value = p.targetWeight ?? "";
      $("moveGoalMin").value = p.moveGoalMin ?? 10;
      $("weighMode").value = p.weighMode ?? "daily";
      $("mealGoal").value = String(p.mealGoal ?? 2);
    }

    function renderAll(){
      const dateISO = $("date")?.value || isoToday();
      const ctx = renderHeader(dateISO);
      renderToday(dateISO, ctx);
      renderMeals(dateISO, ctx);
      renderMove(dateISO, ctx);
      renderProgress(dateISO, ctx);
      renderProfile(dateISO, ctx);
    }

    /* ===== Events wiring ===== */
    $("tabToday").addEventListener("click", ()=>setTab("today"));
    $("tabMeals").addEventListener("click", ()=>setTab("meals"));
    $("tabMove").addEventListener("click", ()=>setTab("move"));
    $("tabProgress").addEventListener("click", ()=>setTab("progress"));
    $("tabProfile").addEventListener("click", ()=>setTab("profile"));

    $("date").addEventListener("change", ()=>{
      $("weight").dataset.autofill="1";
      $("weight").value="";
      renderAll();
    });

    $("saveWeightBtn").addEventListener("click", ()=>{
      const d=$("date").value;
      const w=$("weight").value ? Number($("weight").value) : null;
      if(!d){ toast("bad","Date","Choisis une date."); return; }
      if(w===null || Number.isNaN(w)){ toast("bad","Poids","Entre ton poids."); return; }
      saveWeight(d,w);
      $("weight").dataset.autofill="0";
      syncWinAndXP(d);
      toast("good","Poids","Enregistr√© ‚úÖ", 1500);
      renderAll();
    });

    // meal mode changes
    $("mealMode").addEventListener("change", ()=>{
      const p=loadProfile();
      p.mealMode = $("mealMode").value;
      saveJSON(STORAGE.PROFILE,p);
      toast("info","Repas","Mode mis √† jour.", 1200);
      renderAll();
    });
    $("proteinPref").addEventListener("change", ()=>{
      const p=loadProfile();
      p.proteinPref = $("proteinPref").value;
      saveJSON(STORAGE.PROFILE,p);
      toast("info","Repas","Pr√©f√©rence mise √† jour.", 1200);
      renderAll();
    });

    $("resetChecksBtn").addEventListener("click", ()=>{
      if(!confirm("R√©initialiser toutes les coches repas ?")) return;
      del(STORAGE.MEAL_CHECKS);
      toast("info","Repas","Coches r√©initialis√©es.", 1400);
      renderAll();
    });

    // Anti-fringale
    function cravingOpen(){
      const dateISO = $("date")?.value || isoToday();
      renderCravingSheet(dateISO);
      openSheet();
    }
    $("cravingBtn").addEventListener("click", cravingOpen);
    $("cravingBtn2").addEventListener("click", cravingOpen);
    $("sheetCloseBtn").addEventListener("click", closeSheet);
    $("sheetBack").addEventListener("click", closeSheet);

    // Movement
    $("moveStartBtn").addEventListener("click", ()=>{
      const d=$("date")?.value || isoToday();
      timerStart(d);
    });
    $("moveStopBtn").addEventListener("click", ()=>{
      const d=$("date")?.value || isoToday();
      timerStopAndSave(d);
    });
    $("moveAdd5Btn").addEventListener("click", ()=>{
      const d=$("date")?.value || isoToday();
      addMoveMinutes(d, 5);
      syncWinAndXP(d);
      toast("good","Mouvement","+5 min ‚úÖ", 1200);
      renderAll();
    });
    $("move2minBtn").addEventListener("click", ()=>{
      tMode="2";
      const d=$("date")?.value || isoToday();
      updateTimerUI(d);
      toast("info","Mode","KO : objectif 2 minutes.", 1200);
    });
    $("move10minBtn").addEventListener("click", ()=>{
      tMode="10";
      const d=$("date")?.value || isoToday();
      updateTimerUI(d);
      toast("info","Mode","Objectif normal.", 1200);
    });

    // Profile save
    $("saveProfileBtn").addEventListener("click", ()=>{
      const p=loadProfile();
      p.heightCm = $("height").value ? Number($("height").value) : p.heightCm;
      p.startWeight = $("startWeight").value ? Number($("startWeight").value) : p.startWeight;
      p.targetWeight = $("targetWeight").value ? Number($("targetWeight").value) : p.targetWeight;
      p.moveGoalMin = $("moveGoalMin").value ? Math.max(2, Number($("moveGoalMin").value)) : p.moveGoalMin;
      p.weighMode = $("weighMode").value;
      p.mealGoal = Math.max(1, Number($("mealGoal").value)||2);

      if(!p.startWeight || !p.targetWeight){
        toast("bad","Profil","Remplis poids de d√©part et objectif.", 1800);
        return;
      }

      saveJSON(STORAGE.PROFILE, p);
      toast("good","Profil","Enregistr√© ‚úÖ", 1500);
      renderAll();
      setTab("today");
    });

    // Backup / Import / Reset
    $("exportBackupBtn").addEventListener("click", ()=>{
      const payload={
        version:1,
        exportedAt:new Date().toISOString(),
        profile: loadProfile(),
        weights: loadWeights(),
        mealChecks: loadMealChecks(),
        moves: loadMoves(),
        xp: loadXP(),
        wins: loadWins(),
      };
      const blob=new Blob([JSON.stringify(payload,null,2)], {type:"application/json;charset=utf-8"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url; a.download="coach30_backup.json";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      toast("good","Backup","Export√© ‚úÖ", 1400);
    });

    $("importBackupBtn").addEventListener("click", ()=> $("importFile").click());
    $("importFile").addEventListener("change", async (e)=>{
      const f=e.target.files?.[0];
      if(!f) return;
      try{
        const text=await f.text();
        const payload=JSON.parse(text);
        if(!payload) throw new Error("Fichier invalide");
        if(!confirm("Importer et remplacer tes donn√©es ?")) return;

        if(payload.profile) saveJSON(STORAGE.PROFILE, payload.profile);
        if(Array.isArray(payload.weights)) saveJSON(STORAGE.WEIGHTS, payload.weights);
        if(payload.mealChecks) saveJSON(STORAGE.MEAL_CHECKS, payload.mealChecks);
        if(payload.moves) saveJSON(STORAGE.MOVES, payload.moves);
        if(typeof payload.xp==="number") saveJSON(STORAGE.XP, payload.xp);
        if(payload.wins) saveJSON(STORAGE.WINS, payload.wins);

        toast("good","Import","Termin√© ‚úÖ", 1600);
        renderAll();
      }catch(err){
        toast("bad","Import","√âchec : "+(err?.message||""), 2400);
      }finally{
        e.target.value="";
      }
    });

    $("clearAllBtn").addEventListener("click", ()=>{
      if(!confirm("Tout effacer ?")) return;
      Object.values(STORAGE).forEach(del);
      toast("info","Reset","Donn√©es effac√©es.", 1600);
      // reset timer state
      tRunning=false; tElapsedMs=0; if(tTick) clearInterval(tTick);
      init();
    });

    /* ===== Init ===== */
    function init(){
      // set date
      $("date").value = isoToday();

      // autofill if existing weight today
      const today=isoToday();
      const rows=loadWeights();
      const ex=rows.find(r=>r.date===today);
      if(ex){
        $("weight").value = ex.weight;
        $("weight").dataset.autofill="1";
      }

      // header compact
      initHeaderCompact();

      renderAll();
      setTab("today");
    }

    init();

  })();
});
</script>
</body>
</html>
