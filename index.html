<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FitMotiv ‚Ä¢ Suivi</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#06070F;
      --bg1:#0A0D1A;
      --bg2:#0B1227;

      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.14);

      --txt:#F6F7FF;
      --muted: rgba(246,247,255,.78);
      --muted2: rgba(246,247,255,.55);

      --a1:#7C5CFF;   /* violet */
      --a2:#2EE59D;   /* vert */
      --a3:#FF4D6D;   /* rose */
      --a4:#4DC9FF;   /* bleu */

      --shadow: 0 18px 70px rgba(0,0,0,.58);
      --radius: 18px;
      --radius2: 26px;

      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, "SF Pro Display","SF Pro Text", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1100px 700px at 18% 8%, rgba(124,92,255,.35), transparent 55%),
        radial-gradient(900px 650px at 88% 12%, rgba(46,229,157,.20), transparent 60%),
        radial-gradient(900px 650px at 70% 92%, rgba(255,77,109,.16), transparent 60%),
        radial-gradient(900px 650px at 12% 88%, rgba(77,201,255,.14), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg2));
      overflow-x:hidden;
    }

    .app{
      max-width: 470px;
      margin: 0 auto;
      min-height: 100vh;
      padding: calc(14px + var(--safe-top)) 16px calc(110px + var(--safe-bottom));
    }

    /* Top */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin: 6px 0 14px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .brand .title{
      font-weight: 950;
      letter-spacing: .2px;
      font-size: 22px;
      line-height: 1.05;
    }
    .brand .subtitle{
      font-size: 12.8px;
      color: var(--muted);
      line-height: 1.1rem;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      box-shadow: 0 14px 32px rgba(0,0,0,.28);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      font-size: 12.5px;
      color: var(--muted);
      user-select:none;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: linear-gradient(135deg, var(--a1), var(--a2));
      box-shadow: 0 0 0 4px rgba(124,92,255,.18);
    }

    /* Cards */
    .grid{display:grid; grid-template-columns: 1fr; gap: 12px;}
    .card{
      position:relative;
      overflow:hidden;
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(420px 240px at 20% 0%, rgba(124,92,255,.22), transparent 60%),
        radial-gradient(420px 240px at 92% 32%, rgba(46,229,157,.12), transparent 60%),
        radial-gradient(420px 240px at 30% 90%, rgba(77,201,255,.10), transparent 60%);
      pointer-events:none;
    }
    .card > *{position:relative}

    .h2{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 0 0 10px 0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing: .25px;
    }
    .small{font-size: 12px; color: var(--muted2);}

    /* Inputs */
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;}
    .field{flex:1 1 140px; min-width:140px;}
    label{display:block; font-size: 12px; color: var(--muted); margin-bottom:6px;}
    input{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      outline:none;
      font-size: 14px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }
    input:focus{
      border-color: rgba(124,92,255,.55);
      box-shadow: 0 0 0 4px rgba(124,92,255,.18);
    }

    /* Buttons */
    .btn{
      border:none;
      cursor:pointer;
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 950;
      letter-spacing: .2px;
      font-size: 14px;
      color:#0B1020;
      background: linear-gradient(135deg, var(--a1), var(--a2));
      box-shadow: 0 16px 34px rgba(124,92,255,.22);
      transition: transform .08s ease, filter .2s ease, opacity .2s ease;
      user-select:none;
      width:100%;
    }
    .btn:active{transform: scale(.985)}
    .btn.secondary{
      background: rgba(255,255,255,.08);
      color: var(--txt);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 16px 34px rgba(0,0,0,.20);
    }
    .btn.danger{
      background: rgba(255,77,109,.16);
      color: #FFD5DE;
      border: 1px solid rgba(255,77,109,.25);
      box-shadow:none;
    }
    .btn.ghost{
      background: rgba(255,255,255,.06);
      color: var(--muted);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow:none;
      font-weight: 850;
    }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .kpi{
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .kpi .v{font-size: 18px; font-weight: 950; letter-spacing:.2px;}
    .kpi .l{font-size: 12px; color: var(--muted2); margin-top: 2px;}

    .hint{
      margin-top: 10px;
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.25rem;
    }

    /* List items */
    .list{margin: 10px 0 0 0; padding:0; list-style:none; display:flex; flex-direction:column; gap:10px;}
    .item{
      display:flex;
      gap:10px;
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      align-items:flex-start;
    }
    .badge{
      width:36px;height:36px;border-radius: 13px;
      display:flex;align-items:center;justify-content:center;
      background: linear-gradient(135deg, rgba(124,92,255,.32), rgba(46,229,157,.22));
      border: 1px solid rgba(255,255,255,.14);
      flex: 0 0 auto;
      font-size: 16px;
    }
    .t{font-weight: 950; font-size: 13.5px; margin:0;}
    .d{margin: 3px 0 0 0; color: var(--muted); font-size: 12.7px; line-height: 1.25rem;}
    .chips{margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;}
    .chip{
      font-size: 11.5px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
    }

    .chartWrap{
      margin-top: 10px;
      padding: 12px;
      border-radius: var(--radius);
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      height: 220px;
    }

    /* Logs */
    .tools{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 8px;
    }
    .tools .field{flex: 1 1 160px; min-width: 160px;}
    .mutebar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted2);
      font-size: 12px;
    }

    .logActions{
      display:flex;
      gap:8px;
      margin-top:8px;
    }
    .logActions button{flex:1}

    .logBtns{
      display:flex;
      gap:8px;
      margin-top: 8px;
      flex-wrap:wrap;
    }
    .miniBtn{
      padding: 8px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-weight: 850;
      cursor:pointer;
      user-select:none;
    }
    .miniBtn:active{transform:scale(.99)}

    /* Sections */
    .section{display:none}
    .section.active{display:block}

    /* Bottom tab bar (iOS-ish) */
    .tabs{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 14px calc(12px + var(--safe-bottom));
      background: rgba(10,14,26,.60);
      border-top: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      z-index: 30;
    }
    .tabsInner{
      width: min(470px, 100%);
      margin: 0 auto;
      display:flex;
      gap: 10px;
      position:relative;
    }

    .tabBtn{
      flex:1;
      border:none;
      cursor:pointer;
      padding: 11px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-weight: 950;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: transform .08s ease, background .2s ease, color .2s ease, border-color .2s ease;
      user-select:none;
      position:relative;
      overflow:hidden;
    }
    .tabBtn .ico{
      width:28px;height:28px;border-radius: 12px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 15px;
    }
    .tabBtn:active{transform:scale(.99)}
    .tabBtn.active{
      color: var(--txt);
      border-color: rgba(255,255,255,.16);
      background: linear-gradient(135deg, rgba(124,92,255,.22), rgba(46,229,157,.14));
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
    }
    .tabBtn.active::after{
      content:"";
      position:absolute;
      left: 16px; right: 16px; bottom: 6px;
      height: 3px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--a1), var(--a2));
      opacity:.95;
    }

    /* Modal (edit) */
    .backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 16px 16px calc(16px + var(--safe-bottom));
      z-index: 60;
    }
    .backdrop.show{display:flex}
    .sheet{
      width: min(470px, 100%);
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .sheetHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .sheetHeader .h{
      font-weight: 950;
      letter-spacing:.2px;
    }
    .sheetBody{padding: 14px;}
    .sheetFooter{
      display:flex;
      gap:10px;
      padding: 12px 14px 14px;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .sheetFooter button{flex:1}
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="title">FitMotiv</div>
        <div class="subtitle">Pes√©e du jour ‚Ä¢ Graphique ‚Ä¢ Repas simples ‚Ä¢ Motivation</div>
      </div>
      <div class="pill" title="S√©rie de jours cons√©cutifs avec une pes√©e">
        <span class="dot"></span>
        <span><b id="streak">0</b> jour(s) ‚Ä¢ r√©gularit√©</span>
      </div>
    </div>

    <!-- ACCUEIL -->
    <section id="home" class="section active">
      <div class="grid">

        <div class="card">
          <div class="h2">
            <span>Pes√©e du jour</span>
            <span class="small" id="todayLabel">‚Äî</span>
          </div>

          <div class="row">
            <div class="field">
              <label for="dateInput">Date</label>
              <input id="dateInput" type="date" />
            </div>
            <div class="field">
              <label for="weightInput">Poids (kg)</label>
              <input id="weightInput" type="number" inputmode="decimal" step="0.1" placeholder="ex: 78.4" />
            </div>
          </div>

          <div style="height:8px"></div>
          <button class="btn" id="saveBtn">Enregistrer</button>

          <div class="kpis">
            <div class="kpi">
              <div class="v" id="kpiLast">‚Äî</div>
              <div class="l">Derni√®re pes√©e</div>
            </div>
            <div class="kpi">
              <div class="v" id="kpiDelta">‚Äî</div>
              <div class="l">√âvolution (vs 1√®re)</div>
            </div>
          </div>

          <p class="hint">Focus : r√©gularit√© + constance. Le r√©sultat suit.</p>

          <div class="logActions">
            <button class="btn secondary" id="exportJsonBtn">Exporter JSON</button>
            <button class="btn secondary" id="exportCsvBtn">Exporter CSV</button>
          </div>
          <div class="logActions">
            <button class="btn ghost" id="importBtn">Importer JSON</button>
            <button class="btn danger" id="clearBtn">Tout effacer</button>
          </div>
          <input id="importFile" type="file" accept="application/json" style="display:none;" />
        </div>

        <div class="card">
          <div class="h2">
            <span>√âvolution</span>
            <span class="small" id="rangeLabel">‚Äî</span>
          </div>

          <div class="chartWrap">
            <canvas id="weightChart"></canvas>
          </div>

          <div class="mutebar">
            <span>Min: <b id="minW">‚Äî</b> ‚Ä¢ Max: <b id="maxW">‚Äî</b></span>
            <span>Entr√©es: <b id="countW">0</b></span>
          </div>

          <div class="tools">
            <div class="field">
              <label for="searchInput">Rechercher (date ou poids)</label>
              <input id="searchInput" placeholder="ex: 2026-01 ou 78.4" />
            </div>
            <div class="field">
              <label for="sortSelect">Tri</label>
              <input id="sortSelect" list="sortOptions" />
              <datalist id="sortOptions">
                <option value="Date (r√©cent ‚Üí ancien)"></option>
                <option value="Date (ancien ‚Üí r√©cent)"></option>
                <option value="Poids (haut ‚Üí bas)"></option>
                <option value="Poids (bas ‚Üí haut)"></option>
              </datalist>
            </div>
          </div>

          <ul class="list" id="historyList"></ul>
        </div>

      </div>
    </section>

    <!-- REPAS -->
    <section id="meals" class="section">
      <div class="grid">
        <div class="card">
          <div class="h2">
            <span>Repas simples & rapides</span>
            <span class="small">prot√©ines + l√©gumes</span>
          </div>
          <ul class="list" id="mealList"></ul>
          <p class="hint">
            ‚ÄúSimple qui marche‚Äù : prot√©ines (poisson/poulet/≈ìufs) + l√©gumes (surgel√©s OK) + f√©culents dos√©s si besoin.
          </p>
        </div>
      </div>
    </section>

    <!-- MOTIVATION -->
    <section id="motivation" class="section">
      <div class="grid">
        <div class="card">
          <div class="h2">
            <span>Motivation sport</span>
            <span class="small">petits pas ‚Üí gros r√©sultats</span>
          </div>

          <div class="item">
            <div class="badge">‚ö°</div>
            <div>
              <p class="t" id="quote">‚Äî</p>
              <p class="d" id="quoteSub">‚Äî</p>
              <div class="chips">
                <span class="chip">Discipline</span>
                <span class="chip">R√©gularit√©</span>
                <span class="chip">Mental</span>
              </div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="item">
            <div class="badge">‚úÖ</div>
            <div style="width:100%">
              <p class="t">Checklist du jour</p>
              <div class="d">
                <label style="display:flex; gap:10px; align-items:center; margin:10px 0 0;">
                  <input type="checkbox" id="c1" style="width:18px;height:18px;"> 20‚Äì30 min de marche
                </label>
                <label style="display:flex; gap:10px; align-items:center; margin:10px 0 0;">
                  <input type="checkbox" id="c2" style="width:18px;height:18px;"> 1 portion de l√©gumes en plus
                </label>
                <label style="display:flex; gap:10px; align-items:center; margin:10px 0 0;">
                  <input type="checkbox" id="c3" style="width:18px;height:18px;"> Sommeil (un peu plus t√¥t)
                </label>
              </div>
              <div class="logBtns">
                <button class="miniBtn" id="newQuoteBtn">Nouvelle punchline</button>
                <button class="miniBtn" id="resetChecksBtn">Reset checklist</button>
              </div>
            </div>
          </div>

          <p class="hint">Une mauvaise journ√©e n‚Äôannule pas ton plan. Le lendemain compte plus.</p>
        </div>
      </div>
    </section>
  </div>

  <!-- Bottom tabs -->
  <nav class="tabs" aria-label="Navigation">
    <div class="tabsInner">
      <button class="tabBtn active" data-tab="home">
        <span class="ico">üìà</span><span>Accueil</span>
      </button>
      <button class="tabBtn" data-tab="meals">
        <span class="ico">ü•ó</span><span>Repas</span>
      </button>
      <button class="tabBtn" data-tab="motivation">
        <span class="ico">üèãÔ∏è</span><span>Motivation</span>
      </button>
    </div>
  </nav>

  <!-- Edit sheet -->
  <div class="backdrop" id="editBackdrop" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="sheetHeader">
        <div class="h">Modifier une entr√©e</div>
        <button class="miniBtn" id="closeEditBtn">Fermer</button>
      </div>
      <div class="sheetBody">
        <div class="row">
          <div class="field">
            <label for="editDate">Date</label>
            <input id="editDate" type="date" />
          </div>
          <div class="field">
            <label for="editWeight">Poids (kg)</label>
            <input id="editWeight" type="number" step="0.1" inputmode="decimal" />
          </div>
        </div>
        <p class="hint" style="margin-bottom:0;">Astuce : modifier la date d√©placera l‚Äôentr√©e si besoin.</p>
      </div>
      <div class="sheetFooter">
        <button class="btn secondary" id="deleteEntryBtn">Supprimer</button>
        <button class="btn" id="saveEditBtn">Enregistrer</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    const pad = (n) => String(n).padStart(2,"0");
    const todayISO = () => {
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    };

    const fmtDate = (iso) => {
      if(!iso) return "‚Äî";
      const [y,m,d] = iso.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      return dt.toLocaleDateString("fr-FR", { weekday:"short", year:"numeric", month:"short", day:"2-digit" });
    };

    function prevDayISO(iso){
      const [y,m,d] = iso.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      dt.setDate(dt.getDate()-1);
      return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
    }

    // ---------- Storage ----------
    const KEY = "fitmotiv.weights.v2";
    const CK  = "fitmotiv.checks.v2";

    function loadEntries(){
      try{
        const raw = localStorage.getItem(KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr)
          ? arr.filter(e => e && e.date && typeof e.weight === "number")
          : [];
      }catch{ return []; }
    }

    function saveEntries(entries){
      localStorage.setItem(KEY, JSON.stringify(entries));
    }

    function normalize(entries){
      // merge duplicate dates keeping last
      const map = new Map();
      entries.forEach(e => map.set(e.date, {date:e.date, weight:Number(e.weight)}));
      const out = Array.from(map.values()).filter(e => e.date && Number.isFinite(e.weight) && e.weight > 0);
      out.sort((a,b)=>a.date.localeCompare(b.date));
      return out;
    }

    function upsertEntry(entries, date, weight){
      const i = entries.findIndex(e => e.date === date);
      if(i >= 0) entries[i].weight = weight;
      else entries.push({date, weight});
      entries = normalize(entries);
      return entries;
    }

    function deleteEntry(entries, date){
      return entries.filter(e => e.date !== date);
    }

    function clearAll(){
      localStorage.removeItem(KEY);
      localStorage.removeItem(CK);
    }

    // ---------- Meals ----------
    const meals = [
      { icon:"üêü", title:"Poisson + l√©gumes surgel√©s", desc:"Saumon/colin au four + haricots verts/brocoli (po√™le).", tags:["Rapide","Prot√©ines","Omega-3"] },
      { icon:"üçó", title:"Poulet + salade croquante", desc:"Blanc de poulet + salade + concombre + yaourt citron.", tags:["Simple","Sati√©t√©","Lean"] },
      { icon:"üç≥", title:"Omelette prot√©in√©e", desc:"2‚Äì3 ≈ìufs (ou 1 + blancs) + √©pinards surgel√©s + champignons.", tags:["10 min","Budget","Anti-fringale"] },
      { icon:"ü•£", title:"Bol thon express", desc:"Thon nature + skyr + moutarde + cornichons + crudit√©s.", tags:["Sans cuisson","Tr√®s prot√©in√©","Pr√™t vite"] },
      { icon:"ü¶É", title:"Dinde + wok", desc:"√âminc√© de dinde + m√©lange wok surgel√© + sauce soja light.", tags:["Go√ªt","Wok","Sport"] },
      { icon:"ü•©", title:"Steak 5% + ratatouille", desc:"Steak hach√© 5% + ratatouille surgel√©e + √©pices.", tags:["Simple","Sati√©tant","Prot√©ines"] },
      { icon:"üç≤", title:"Soupe + prot√©ines", desc:"Soupe de l√©gumes + ≈ìufs durs ou poulet effiloch√©.", tags:["Confort","Volume","Light"] },
      { icon:"üßÄ", title:"Skyr + fruits (portion)", desc:"Skyr nature + fruits rouges + 10‚Äì15g de noix.", tags:["Petit-d√©j","Sucr√© malin","Prot√©ines"] },
    ];

    function renderMeals(){
      const ul = $("#mealList");
      ul.innerHTML = "";
      meals.forEach(m => {
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = `
          <div class="badge">${m.icon}</div>
          <div>
            <p class="t">${m.title}</p>
            <p class="d">${m.desc}</p>
            <div class="chips">${m.tags.map(t => `<span class="chip">${t}</span>`).join("")}</div>
          </div>
        `;
        ul.appendChild(li);
      });
    }

    // ---------- Motivation ----------
    const quotes = [
      {q:"La motivation te lance. La discipline te transforme.", s:"Aujourd‚Äôhui : une action simple, et on avance."},
      {q:"R√©gulier > parfait.", s:"80% bien fait vaut mieux que 0% parfait."},
      {q:"Tu n‚Äôes qu‚Äô√† une d√©cision d‚Äôun meilleur toi.", s:"Choisis le prochain bon choix."},
      {q:"Ton futur toi te remercie d√©j√†.", s:"Les petites victoires se cumulent."},
      {q:"Chaque s√©ance est un vote pour ta meilleure version.", s:"Vote aujourd‚Äôhui."},
      {q:"Le corps suit ce que le mental r√©p√®te.", s:"R√©p√®te : je continue."},
    ];

    function pickQuote(){
      const x = quotes[Math.floor(Math.random()*quotes.length)];
      $("#quote").textContent = x.q;
      $("#quoteSub").textContent = x.s;
    }

    // Checklist persistence
    function loadChecks(){
      try{
        const raw = localStorage.getItem(CK);
        return raw ? JSON.parse(raw) : {c1:false,c2:false,c3:false, date: todayISO()};
      }catch{
        return {c1:false,c2:false,c3:false, date: todayISO()};
      }
    }
    function saveChecks(obj){ localStorage.setItem(CK, JSON.stringify(obj)); }

    function initChecks(){
      let st = loadChecks();
      const t = todayISO();
      if(st.date !== t){
        st = {c1:false,c2:false,c3:false, date:t};
        saveChecks(st);
      }
      ["c1","c2","c3"].forEach(id=>{
        const el = $("#"+id);
        el.checked = !!st[id];
        el.addEventListener("change", ()=>{
          const cur = loadChecks();
          cur[id] = el.checked;
          cur.date = todayISO();
          saveChecks(cur);
        });
      });

      $("#resetChecksBtn").addEventListener("click", ()=>{
        const st2 = {c1:false,c2:false,c3:false, date: todayISO()};
        saveChecks(st2);
        ["c1","c2","c3"].forEach(id => $("#"+id).checked = false);
      });
    }

    // ---------- Chart ----------
    let chart;

    function makeGradient(ctx){
      const g = ctx.createLinearGradient(0, 0, 0, 220);
      g.addColorStop(0, "rgba(124,92,255,0.42)");
      g.addColorStop(0.55, "rgba(46,229,157,0.10)");
      g.addColorStop(1, "rgba(0,0,0,0)");
      return g;
    }

    function buildChart(entries){
      const canvas = $("#weightChart");
      const ctx = canvas.getContext("2d");

      const labels = entries.map(e => e.date);
      const data = entries.map(e => e.weight);

      // dynamic bounds (nicer)
      let min = Math.min(...data, 0);
      let max = Math.max(...data, 0);
      if(data.length){
        const pad = Math.max(0.6, (max - min) * 0.18);
        min = Math.floor((min - pad) * 10) / 10;
        max = Math.ceil((max + pad) * 10) / 10;
      }

      const gradient = makeGradient(ctx);

      const cfg = {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Poids (kg)",
            data,
            tension: 0.38,
            borderWidth: 3,
            pointRadius: 3.4,
            pointHoverRadius: 5.5,
            fill: true,
            backgroundColor: gradient,
            borderColor: "rgba(124,92,255,0.98)",
            pointBackgroundColor: "rgba(46,229,157,0.98)",
            pointBorderColor: "rgba(0,0,0,0)",
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 550 },
          plugins: {
            legend: { display:false },
            tooltip: {
              backgroundColor: "rgba(10,14,26,.92)",
              borderColor: "rgba(255,255,255,.14)",
              borderWidth: 1,
              titleColor: "rgba(246,247,255,.95)",
              bodyColor: "rgba(246,247,255,.85)",
              displayColors: false,
              callbacks: {
                title: (items)=> items?.[0]?.label ? fmtDate(items[0].label) : "",
                label: (item)=> ` ${item.formattedValue} kg`
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: "rgba(246,247,255,.65)",
                maxTicksLimit: 6
              },
              grid: { color: "rgba(255,255,255,.06)" }
            },
            y: {
              suggestedMin: data.length ? min : undefined,
              suggestedMax: data.length ? max : undefined,
              ticks: { color: "rgba(246,247,255,.65)" },
              grid: { color: "rgba(255,255,255,.06)" }
            }
          }
        }
      };

      if(chart) chart.destroy();
      chart = new Chart(canvas, cfg);
    }

    // ---------- Logs (complete) ----------
    function computeStreak(entries){
      if(!entries.length) return 0;
      const set = new Set(entries.map(e=>e.date));
      let cur = set.has(todayISO()) ? todayISO() : entries.at(-1).date;
      let streak = 0;
      while(set.has(cur)){
        streak++;
        cur = prevDayISO(cur);
      }
      return streak;
    }

    function stats(entries){
      if(!entries.length) return {min:null,max:null};
      let min = entries[0].weight, max = entries[0].weight;
      for(const e of entries){
        if(e.weight < min) min = e.weight;
        if(e.weight > max) max = e.weight;
      }
      return {min,max};
    }

    // Filter + sort
    function getFilteredSorted(entries){
      const q = ($("#searchInput").value || "").trim().toLowerCase();
      let out = entries;

      if(q){
        out = out.filter(e =>
          e.date.toLowerCase().includes(q) ||
          String(e.weight).toLowerCase().includes(q)
        );
      }

      const sortLabel = ($("#sortSelect").value || "Date (r√©cent ‚Üí ancien)").trim();
      const byDateAsc = (a,b)=>a.date.localeCompare(b.date);
      const byDateDesc = (a,b)=>b.date.localeCompare(a.date);
      const byWAsc = (a,b)=>a.weight - b.weight;
      const byWDesc = (a,b)=>b.weight - a.weight;

      if(sortLabel === "Date (ancien ‚Üí r√©cent)") out = [...out].sort(byDateAsc);
      else if(sortLabel === "Poids (haut ‚Üí bas)") out = [...out].sort(byWDesc);
      else if(sortLabel === "Poids (bas ‚Üí haut)") out = [...out].sort(byWAsc);
      else out = [...out].sort(byDateDesc);

      return out;
    }

    function renderHistory(entries){
      // KPIs & meta
      const last = entries.at(-1);
      const first = entries[0];

      $("#kpiLast").textContent = last ? `${last.weight.toFixed(1)} kg` : "‚Äî";
      if(last && first){
        const delta = last.weight - first.weight;
        const sign = delta > 0 ? "+" : "";
        $("#kpiDelta").textContent = `${sign}${delta.toFixed(1)} kg`;
      } else {
        $("#kpiDelta").textContent = "‚Äî";
      }

      // Range
      if(entries.length >= 2){
        $("#rangeLabel").textContent = `${fmtDate(entries[0].date)} ‚Üí ${fmtDate(entries.at(-1).date)}`;
      } else if(entries.length === 1){
        $("#rangeLabel").textContent = fmtDate(entries[0].date);
      } else {
        $("#rangeLabel").textContent = "Aucune donn√©e";
      }

      // streak
      $("#streak").textContent = computeStreak(entries);

      // stats
      const s = stats(entries);
      $("#minW").textContent = s.min == null ? "‚Äî" : `${s.min.toFixed(1)} kg`;
      $("#maxW").textContent = s.max == null ? "‚Äî" : `${s.max.toFixed(1)} kg`;
      $("#countW").textContent = String(entries.length);

      // full logs (filtered/sorted)
      const ul = $("#historyList");
      ul.innerHTML = "";

      const shown = getFilteredSorted(entries);

      if(!shown.length){
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = `
          <div class="badge">üîé</div>
          <div>
            <p class="t">Aucune entr√©e</p>
            <p class="d">Change la recherche/tri, ou ajoute une pes√©e.</p>
          </div>
        `;
        ul.appendChild(li);
        return;
      }

      shown.forEach((e, idx) => {
        const li = document.createElement("li");
        li.className = "item";
        const isLatest = (entries.at(-1)?.date === e.date);
        li.innerHTML = `
          <div class="badge">${isLatest ? "‚≠ê" : "üìå"}</div>
          <div style="flex:1;">
            <p class="t">${fmtDate(e.date)}</p>
            <p class="d"><b style="color:rgba(246,247,255,.95)">${e.weight.toFixed(1)} kg</b></p>
            <div class="chips">
              <span class="chip">Date: ${e.date}</span>
              <span class="chip">Tap pour modifier</span>
            </div>
          </div>
        `;
        li.addEventListener("click", ()=> openEditSheet(e.date));
        ul.appendChild(li);
      });
    }

    function refresh(){
      const entries = loadEntries().sort((a,b)=>a.date.localeCompare(b.date));
      buildChart(entries);
      renderHistory(entries);
    }

    // ---------- Actions ----------
    function initHome(){
      const t = todayISO();
      $("#dateInput").value = t;
      $("#todayLabel").textContent = fmtDate(t);

      $("#dateInput").addEventListener("change", () => {
        $("#todayLabel").textContent = fmtDate($("#dateInput").value);
      });

      $("#saveBtn").addEventListener("click", () => {
        const date = $("#dateInput").value || todayISO();
        const w = Number($("#weightInput").value);
        if(!date){ alert("Choisis une date."); return; }
        if(!Number.isFinite(w) || w <= 0){
          alert("Entre un poids valide (ex: 78.4).");
          return;
        }
        let entries = loadEntries();
        entries = upsertEntry(entries, date, Math.round(w*10)/10);
        saveEntries(entries);

        $("#weightInput").value = "";
        refresh();

        const btn = $("#saveBtn");
        const old = btn.textContent;
        btn.textContent = "Enregistr√© ‚úÖ";
        setTimeout(()=> btn.textContent = old, 900);
      });

      // search / sort refresh
      $("#searchInput").addEventListener("input", refresh);
      $("#sortSelect").addEventListener("input", refresh);

      // clear
      $("#clearBtn").addEventListener("click", () => {
        const ok = confirm("Tout effacer ? (pes√©es + checklist)");
        if(!ok) return;
        clearAll();
        refresh();
        initChecks();
      });

      // export JSON
      $("#exportJsonBtn").addEventListener("click", () => {
        const entries = loadEntries();
        const blob = new Blob([JSON.stringify(entries, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "fitmotiv-poids.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      // export CSV
      $("#exportCsvBtn").addEventListener("click", () => {
        const entries = loadEntries().sort((a,b)=>a.date.localeCompare(b.date));
        const header = "date,weight\n";
        const rows = entries.map(e => `${e.date},${e.weight}`).join("\n");
        const csv = header + rows + "\n";
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "fitmotiv-poids.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      // import JSON
      $("#importBtn").addEventListener("click", ()=> $("#importFile").click());
      $("#importFile").addEventListener("change", async (ev)=>{
        const file = ev.target.files?.[0];
        if(!file) return;
        try{
          const text = await file.text();
          const data = JSON.parse(text);
          if(!Array.isArray(data)) throw new Error("Format invalide");
          const merged = normalize([...loadEntries(), ...data]);
          saveEntries(merged);
          refresh();
          alert("Import r√©ussi ‚úÖ");
        }catch(err){
          alert("Import impossible. V√©rifie que c‚Äôest un JSON d‚Äôentr√©es (date/weight).");
        }finally{
          ev.target.value = "";
        }
      });
    }

    // ---------- Tabs ----------
    function initTabs(){
      $$(".tabBtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          $$(".tabBtn").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          const id = btn.dataset.tab;
          $$(".section").forEach(s=>s.classList.remove("active"));
          $("#"+id).classList.add("active");
        });
      });
    }

    // ---------- Edit Sheet ----------
    let editOriginalDate = null;

    function openEditSheet(date){
      const entries = loadEntries();
      const e = entries.find(x => x.date === date);
      if(!e) return;

      editOriginalDate = date;
      $("#editDate").value = e.date;
      $("#editWeight").value = e.weight.toFixed(1);

      $("#editBackdrop").classList.add("show");
    }

    function closeEditSheet(){
      $("#editBackdrop").classList.remove("show");
      editOriginalDate = null;
    }

    function initEditSheet(){
      $("#closeEditBtn").addEventListener("click", closeEditSheet);
      $("#editBackdrop").addEventListener("click", (ev)=>{
        if(ev.target.id === "editBackdrop") closeEditSheet();
      });

      $("#saveEditBtn").addEventListener("click", ()=>{
        const newDate = $("#editDate").value;
        const newW = Number($("#editWeight").value);
        if(!newDate){ alert("Choisis une date."); return; }
        if(!Number.isFinite(newW) || newW <= 0){ alert("Poids invalide."); return; }

        let entries = loadEntries();

        // delete old then upsert new
        if(editOriginalDate) entries = deleteEntry(entries, editOriginalDate);
        entries = upsertEntry(entries, newDate, Math.round(newW*10)/10);
        saveEntries(entries);

        closeEditSheet();
        refresh();
      });

      $("#deleteEntryBtn").addEventListener("click", ()=>{
        if(!editOriginalDate) return;
        const ok = confirm("Supprimer cette entr√©e ?");
        if(!ok) return;
        let entries = loadEntries();
        entries = deleteEntry(entries, editOriginalDate);
        saveEntries(entries);
        closeEditSheet();
        refresh();
      });
    }

    // ---------- Boot ----------
    renderMeals();
    pickQuote();
    $("#newQuoteBtn").addEventListener("click", pickQuote);

    initTabs();
    initHome();
    initChecks();
    initEditSheet();
    refresh();
  </script>
</body>
</html>